<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d1b2a">
    <title>Funorte Hub</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.imgur.com/INUxxnc.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #0d1b2a;
            --primary-light: #1b263b;
            --accent: #e63946;
            --white: #ffffff;
            --gray: #f0f0f0;
            --dark-gray: #333;
            --light-gray: #e0e0e0;
            --success: #2ecc71;
            --warning: #f39c12;
            --error: #e74c3c;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--primary-dark);
            color: var(--white);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            overflow: hidden;
            position: relative;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.5s ease, opacity 0.5s ease;
            background-color: var(--primary-dark);
            overflow-y: auto;
            padding: 0;
            z-index: 10;
        }

        .screen.hidden {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }

        .screen.active {
            transform: translateX(0);
            opacity: 1;
            z-index: 20;
        }

        .header {
            background-color: var(--primary-dark);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            position: relative; /* Adicionado para o beta-tag */
        }

        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .assistant-message {
            background-color: var(--primary-light);
            padding: 15px;
            margin: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 10px;
            animation: fadeIn 0.5s ease;
        }

        .assistant-icon {
            background-color: var(--accent);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .assistant-text {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            margin-top: 10px;
        }

        .btn {
            padding: 15px 20px;
            border-radius: 12px;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background-color: var(--accent);
            color: var(--white);
        }

        .btn-secondary {
            background-color: var(--primary-light);
            color: var(--white);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .footer {
            text-align: center;
            padding: 20px;
            font-size: 0.8rem;
            color: var(--light-gray);
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .form-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            padding: 14px;
            border-radius: 10px;
            border: 2px solid var(--primary-light);
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
            font-size: 1rem;
            transition: var(--transition);
        }

        /* Estilo para selects - fundo azul e texto branco */
        select.form-control {
            background-color: var(--primary-light);
            color: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .card {
            background-color: var(--primary-light);
            border-radius: 12px;
            padding: 20px;
            margin: 15px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .card-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
        }

        .module-card {
            background-color: var(--primary-light);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            min-height: 140px;
            position: relative; /* Adicionado para o badge */
        }

        .module-card:active {
            transform: scale(0.97);
        }

        .module-card i {
            font-size: 2rem;
            color: var(--accent);
        }

        .module-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .module-card.disabled i {
            color: var(--light-gray);
        }

        /* ÍCONE BETA AUMENTADO EM 35% */
        .beta-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--accent);
            color: white;
            font-size: 0.81rem; /* Aumentado em 35% (0.6 * 1.35) */
            padding: 3px 7px;   /* Aumentado proporcionalmente */
            border-radius: 10px;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 480px;
                margin: 0 auto;
                box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .module-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Ajuste para formulário em telas pequenas */
        @media (max-width: 767px) {
            .form-row {
                flex-direction: column;
                gap: 8px;
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal para criação de usuários */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--primary-light);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-close {
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Estilos para a tela de perfil do aluno */
        .profile-container {
            padding: 15px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background-color: var(--primary-light);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-course {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Estilos para a tela de avaliação detalhada */
        .evaluation-container {
            padding: 15px;
        }

        .evaluation-header {
            margin-bottom: 20px;
        }

        .evaluation-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .evaluation-date {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .evaluation-content {
            background-color: var(--primary-light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .evaluation-text {
            line-height: 1.6;
        }

        /* Estilos para a tela de admin */
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .admin-btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .admin-btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .admin-btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .admin-btn-primary {
            background-color: #3498db;
            color: white;
        }

        .admin-btn-success {
            background-color: var(--success);
            color: white;
        }

        /* Estilos para notificações */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Estilos para a barra de busca */
        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            padding-left: 40px;
            border-radius: 10px;
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
            font-size: 0.9rem;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-gray);
        }

        /* Estilos para visualização de diário */
        .diary-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .diary-modal-content {
            background-color: var(--primary-light);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .diary-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .diary-modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .diary-modal-close {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .diary-content {
            margin-top: 15px;
            line-height: 1.6;
        }

        .diary-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--light-gray);
        }

        .diary-grade {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .diary-comments {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        /* Paginação */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
        }

        .page-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            background-color: var(--primary-light);
            color: white;
            cursor: pointer;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Estilo para notificação de bloqueio */
        .blocked-message {
            background-color: var(--error);
            color: white;
            padding: 15px;
            margin: 15px;
            border-radius: 12px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        /* Estilo para mensagens persistentes */
        .persistent-message {
            background-color: var(--warning);
            color: white;
            padding: 15px;
            margin: 15px;
            border-radius: 12px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        /* Estilo para swipe de notificações */
        .notification-item {
            position: relative;
            overflow: hidden;
        }

        .notification-swipe {
            position: absolute;
            top: 0;
            right: -80px;
            width: 80px;
            height: 100%;
            background-color: var(--error);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: right 0.3s ease;
        }

        .notification-item.swiping .notification-swipe {
            right: 0;
        }

        .notification-item.deleting .notification-swipe {
            right: 0;
        }

        /* Novo estilo para o modal de motivo de bloqueio */
        .block-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .block-modal-content {
            background-color: var(--primary-light);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
        }

        .block-modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .block-modal-textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }

        .block-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .blocked-icon {
            color: var(--error);
            margin-left: 5px;
        }
        
        /* Estilo para tela VirtualClass */
        .webview-container {
            width: 100%;
            height: calc(100% - 60px);
            border: none;
        }
        
        /* Estilo para o loader do VirtualClass */
        #virtualclass-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
        }
        
        /* Estilo para o rodapé com logo */
        .footer-logo {
            width: 100px;
            margin-bottom: 10px;
        }

        /* Estilo para o modal de ícones de perfil */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .icon-option {
            width: 50px;
            height: 50px;
            background-color: var(--primary-light);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-option:hover, .icon-option.selected {
            background-color: var(--accent);
            transform: scale(1.1);
        }

        /* Estilo para o gerenciamento de mensagens */
        .message-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-content {
            flex: 1;
        }

        .message-expiration {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* NOVOS ESTILOS PARA UPLOAD DE IMAGENS */
        .images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--primary-light);
        }

        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--error);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .image-upload-btn {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .image-upload-input {
            display: none;
        }

        .image-uploading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-uploading .spinner {
            width: 30px;
            height: 30px;
            border-width: 3px;
        }

        /* Carrossel de imagens */
        .carousel-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .carousel-container {
            width: 90%;
            max-width: 800px;
            height: 80vh;
            position: relative;
        }

        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .carousel-image.active {
            display: block;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
        }

        .carousel-prev {
            left: 15px;
        }

        .carousel-next {
            right: 15px;
        }

        .carousel-close {
            position: absolute;
            top: 15px;
            right: 15px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10;
        }

        .carousel-counter {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* NOVO: Estilo para miniaturas de imagens na avaliação */
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Tela Inicial -->
        <div id="home-screen" class="screen active">
            <div class="header">
                <h1>Funorte Hub</h1>
            </div>
            
            <div class="assistant-message fade-in">
                <div class="assistant-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="assistant-text">
                    Olá! Eu sou o assistente virtual Funorte Hub. Bem-vindo ao nosso aplicativo! Aqui você pode registrar seus diários de campo, acompanhar suas atividades e muito mais.
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-primary" onclick="showScreen('login-screen')">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button class="btn btn-secondary" onclick="showScreen('register-screen')">
                    <i class="fas fa-user-plus"></i> Registrar
                </button>
            </div>
            
            <div class="footer">
                <img src="https://i.imgur.com/X7zXKVe.png" alt="Funorte Hub Logo" class="footer-logo">
                Funorte Hub © 2025 - Todos os direitos reservados
            </div>
        </div>
        
        <!-- Tela de Registro -->
        <div id="register-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('home-screen')"></i> Registrar</h1>
            </div>
            
            <div class="assistant-message">
                <div class="assistant-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="assistant-text">
                    Vou te ajudar com o registro da sua conta! Lembre-se de acessar o VirtualClass para visualizar seu número de matrícula.
                </div>
            </div>
            
            <div class="form-container">
                <div class="form-group">
                    <label for="fullname">Nome Completo</label>
                    <input type="text" id="fullname" class="form-control" placeholder="Digite seu nome completo">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="birthdate">Data de Nascimento</label>
                        <input type="date" id="birthdate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="cpf">CPF</label>
                        <input type="text" id="cpf" class="form-control" placeholder="000.000.000-00" maxlength="14">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="registration">Número de Matrícula</label>
                    <input type="text" id="registration" class="form-control" placeholder="Digite sua matrícula">
                </div>
                
                <div class="form-group">
                    <label for="course">Curso</label>
                    <select id="course" class="form-control">
                        <option value="">Selecione seu curso</option>
                        <option value="medicine">Medicina</option>
                        <option value="nursing">Enfermagem</option>
                        <option value="dentistry">Odontologia</option>
                        <option value="physiotherapy">Fisioterapia</option>
                        <option value="nutrition">Nutrição</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="username">Nome de Usuário</label>
                    <input type="text" id="username" class="form-control" placeholder="Crie um nome de usuário">
                </div>
                
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" class="form-control" placeholder="Crie uma senha">
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="showScreen('home-screen')">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary" onclick="registerUser()">
                        <i class="fas fa-check"></i> Concluir
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tela de Login -->
        <div id="login-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('home-screen')"></i> Login</h1>
            </div>
            
            <div class="form-container">
                <div class="form-group">
                    <label for="login-username">Nome de Usuário</label>
                    <input type="text" id="login-username" class="form-control" placeholder="Digite seu nome de usuário">
                </div>
                
                <div class="form-group">
                    <label for="login-password">Senha</label>
                    <input type="password" id="login-password" class="form-control" placeholder="Digite sua senha">
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="showScreen('home-screen')">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary" onclick="loginUser()">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </div>
            </div>
            
            <div id="user-type-indicator" class="assistant-message" style="display: none;">
                <div class="assistant-icon">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="assistant-text">
                    Identificamos que você é um <strong id="user-type">aluno</strong>
                </div>
            </div>

            <!-- Mensagem de bloqueio -->
            <div id="blocked-message" class="blocked-message" style="display: none;">
                Sua conta está bloqueada. Motivo: <span id="block-reason"></span>
            </div>
        </div>
        
        <!-- Tela do Professor -->
        <div id="teacher-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="logout()"></i> Painel do Professor</h1>
                <div style="display: flex; gap: 10px;">
                    <button id="create-user-btn" class="btn btn-primary" onclick="showCreateUserModal()" style="padding: 8px 12px; font-size: 0.9rem; display: none;">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button id="send-message-btn" class="btn btn-primary" onclick="showSendMessageModal()" style="padding: 8px 12px; font-size: 0.9rem; display: none;">
                        <i class="fas fa-bullhorn"></i>
                    </button>
                    <button id="manage-messages-btn" class="btn btn-primary" onclick="showMessagesScreen()" style="padding: 8px 12px; font-size: 0.9rem; display: none;">
                        <i class="fas fa-envelope"></i>
                    </button>
                    <button class="notification-btn" onclick="showNotifications()" style="display: none;">
                        <i class="fas fa-bell"></i>
                        <span id="notification-count" class="notification-badge" style="display: none;">0</span>
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Alunos</div>
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <select id="teacher-course-select" class="form-control" onchange="loadStudents()">
                            <option value="">Selecione o curso</option>
                            <option value="medicine">Medicina</option>
                            <option value="nursing">Enfermagem</option>
                            <option value="dentistry">Odontologia</option>
                            <option value="physiotherapy">Fisioterapia</option>
                            <option value="nutrition">Nutrição</option>
                        </select>
                    </div>
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-student-alunos" class="search-input" placeholder="Buscar aluno..." oninput="filterStudents()">
                    </div>
                    <div id="students-list">
                        <p>Selecione um curso para visualizar os alunos.</p>
                    </div>
                    <div id="students-pagination" class="pagination" style="display: none;">
                        <button class="page-btn" onclick="prevStudentsPage()" id="prev-student-btn" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="students-page-info">Página 1 de 1</span>
                        <button class="page-btn" onclick="nextStudentsPage()" id="next-student-btn" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Card para professores (apenas admin) -->
            <div id="teachers-card" class="card" style="display: none;">
                <div class="card-header">
                    <div class="card-title">Professores</div>
                </div>
                <div class="card-content">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-professor" class="search-input" placeholder="Buscar professor..." oninput="filterTeachers()">
                    </div>
                    <div id="teachers-list">
                        <p>Carregando professores...</p>
                    </div>
                    <div id="teachers-pagination" class="pagination" style="display: none;">
                        <button class="page-btn" onclick="prevTeachersPage()" id="prev-teacher-btn" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="teachers-page-info">Página 1 de 1</span>
                        <button class="page-btn" onclick="nextTeachersPage()" id="next-teacher-btn" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Avaliação</div>
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <select id="evaluation-course-select" class="form-control" onchange="loadSubmissions()">
                            <option value="">Selecione o curso</option>
                            <option value="medicine">Medicina</option>
                            <option value="nursing">Enfermagem</option>
                            <option value="dentistry">Odontologia</option>
                            <option value="physiotherapy">Fisioterapia</option>
                            <option value="nutrition">Nutrição</option>
                        </select>
                    </div>
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-student" class="search-input" placeholder="Buscar aluno..." oninput="filterSubmissions()">
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="filter-my-students" onchange="loadSubmissions()">
                            Apenas meus alunos
                        </label>
                    </div>
                    <div id="submissions-list">
                        <p>Selecione um curso para visualizar as submissões.</p>
                    </div>
                    <div id="submissions-pagination" class="pagination" style="display: none;">
                        <button class="page-btn" onclick="prevSubmissionsPage()" id="prev-submission-btn" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="submissions-page-info">Página 1 de 1</span>
                        <button class="page-btn" onclick="nextSubmissionsPage()" id="next-submission-btn" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tela Funorte Hub (Aluno) -->
        <div id="hub-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="logout()"></i> Funorte Hub</h1>
                <button class="notification-btn" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span id="student-notification-count" class="notification-badge" style="display: none;">0</span>
                </button>
            </div>
            
            <div class="assistant-message">
                <div class="assistant-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="assistant-text">
                    Olá, <span id="user-greeting">usuário</span>! Você está no espaço virtual da Funorte! Aqui você pode registrar seus diários de campo, acompanhar suas atividades e muito mais.
                </div>
            </div>
            
            <!-- Mensagens persistentes -->
            <div id="persistent-messages-container"></div>
            
            <div class="module-grid">
                <div class="module-card" onclick="showScreen('diary-screen')">
                    <i class="fas fa-book-medical"></i>
                    <div>Registro de Diário de Campo</div>
                </div>
                
                <div class="module-card" onclick="showScreen('submissions-screen')">
                    <i class="fas fa-history"></i>
                    <div>Meus Envios</div>
                </div>
                
                <div class="module-card" onclick="showProfile()">
                    <i class="fas fa-user"></i>
                    <div>Meu Perfil</div>
                </div>
                
                <div class="module-card" onclick="openVirtualClass()">
                    <i class="fas fa-globe"></i>
                    <div>VirtualClass</div>
                </div>
                
                <div class="module-card disabled">
                    <i class="fas fa-comments"></i>
                    <div>Fórum</div>
                    <span class="beta-badge">Beta</span>
                </div>
                
                <div class="module-card" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <div>Sair</div>
                </div>
            </div>
        </div>
        
        <!-- Tela de Registro de Diário de Campo -->
        <div id="diary-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="backFromDiaryScreen()"></i> Novo Diário</h1>
            </div>
            
            <div class="form-container">
                <div class="assistant-message">
                    <div class="assistant-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="assistant-text">
                        Verifique com seu preceptor ou coordenador do curso o prazo máximo para envio do diário de campo. Submissões fora do prazo podem não ser aceitas!
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="diary-date">Data do Registro</label>
                    <input type="date" id="diary-date" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label for="diary-title">Título</label>
                    <input type="text" id="diary-title" class="form-control" placeholder="Título da atividade">
                </div>
                
                <div class="form-group">
                    <label for="diary-text">Descrição</label>
                    <textarea id="diary-text" class="form-control" rows="6" placeholder="Descreva bem a sua prática, não deixe de informar a data, horário e local da atividade!"></textarea>
                </div>
                
                <!-- Container para upload de imagens -->
                <div class="form-group">
                    <label>Upload de Fotos (Máximo 5)</label>
                    <div id="image-upload-container" class="images-container">
                        <!-- Botão para adicionar imagens -->
                        <div class="image-upload-btn" onclick="document.getElementById('image-input').click()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    <input type="file" id="image-input" class="image-upload-input" accept="image/*" multiple>
                </div>
                
                <div class="form-group">
                    <label for="professor">Professor Responsável</label>
                    <select id="professor" class="form-control">
                        <option value="">Selecione o professor</option>
                        <!-- Professores serão carregados dinamicamente -->
                    </select>
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="backFromDiaryScreen()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" id="submit-diary-btn" onclick="submitDiary()">
                        <i class="fas fa-paper-plane"></i> Enviar Diário
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tela de Meus Envios -->
        <div id="submissions-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('hub-screen')"></i> Meus Envios</h1>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Diários de Campo</div>
                    <i class="fas fa-filter"></i>
                </div>
                <div class="card-content" id="my-submissions-list">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Tela de Perfil do Aluno -->
        <div id="profile-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('hub-screen')"></i> Meu Perfil</h1>
            </div>
            
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar" onclick="showIconSelector()">
                        <i class="fas fa-user" id="profile-icon"></i>
                    </div>
                    <div class="profile-info">
                        <div class="profile-name" id="profile-name">Nome do Aluno</div>
                        <div class="profile-course" id="profile-course">Curso</div>
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px; cursor: pointer;" onclick="showIconSelector()">
                            <i class="fas fa-edit"></i> Editar ícone
                        </div>
                    </div>
                </div>
                
                <div class="form-container">
                    <div class="form-group">
                        <label for="edit-fullname">Nome Completo</label>
                        <input type="text" id="edit-fullname" class="form-control">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-birthdate">Data de Nascimento</label>
                            <input type="date" id="edit-birthdate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="edit-cpf">CPF</label>
                            <input type="text" id="edit-cpf" class="form-control" maxlength="14">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-registration">Número de Matrícula</label>
                        <input type="text" id="edit-registration" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-course">Curso</label>
                        <select id="edit-course" class="form-control" disabled>
                            <option value="medicine">Medicina</option>
                            <option value="nursing">Enfermagem</option>
                            <option value="dentistry">Odontologia</option>
                            <option value="physiotherapy">Fisioterapia</option>
                            <option value="nutrition">Nutrição</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-username">Nome de Usuário</label>
                        <input type="text" id="edit-username" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-password">Nova Senha</label>
                        <input type="password" id="edit-password" class="form-control" placeholder="Deixe em branco para manter a atual">
                    </div>
                    
                    <div class="btn-container">
                        <button class="btn btn-secondary" onclick="showScreen('hub-screen')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-primary" onclick="updateProfile()">
                            <i class="fas fa-save"></i> Salvar Alterações
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tela de Visualização de Aluno (Professor/Admin) -->
        <div id="student-view-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('teacher-screen')"></i> Perfil do Aluno</h1>
            </div>
            
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-info">
                        <div class="profile-name" id="student-view-name">Nome do Aluno</div>
                        <div class="profile-course" id="student-view-course">Curso</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Informações do Aluno</div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label>Data de Nascimento</label>
                            <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="student-view-birthdate"></div>
                        </div>
                        <div class="form-group">
                            <label>CPF</label>
                            <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="student-view-cpf"></div>
                        </div>
                        <div class="form-group">
                            <label>Matrícula</label>
                            <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="student-view-registration"></div>
                        </div>
                        <!-- Motivo de bloqueio -->
                        <div id="student-view-block-reason" class="form-group" style="display: none;">
                            <label>Motivo do Bloqueio</label>
                            <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="student-block-reason"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Diários de Campo</div>
                    </div>
                    <div class="card-content" id="student-diaries-list">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div id="admin-actions-container" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Ações Administrativas</div>
                        </div>
                        <div class="card-content">
                            <div class="admin-actions">
                                <button class="admin-btn admin-btn-primary" onclick="editStudent()">
                                    <i class="fas fa-edit"></i> Editar Aluno
                                </button>
                                <button id="block-student-btn" class="admin-btn admin-btn-warning" onclick="showBlockModal()">
                                    <i class="fas fa-ban"></i> Bloquear Aluno
                                </button>
                                <button class="admin-btn admin-btn-danger" onclick="deleteStudent()">
                                    <i class="fas fa-trash"></i> Excluir Aluno
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tela de Edição de Aluno (Admin) -->
        <div id="edit-student-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('student-view-screen')"></i> Editar Aluno</h1>
            </div>
            
            <div class="form-container">
                <div class="form-group">
                    <label for="edit-student-fullname">Nome Completo</label>
                    <input type="text" id="edit-student-fullname" class="form-control">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-student-birthdate">Data de Nascimento</label>
                        <input type="date" id="edit-student-birthdate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="edit-student-cpf">CPF</label>
                        <input type="text" id="edit-student-cpf" class="form-control" maxlength="14">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-student-registration">Número de Matrícula</label>
                    <input type="text" id="edit-student-registration" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="edit-student-course">Curso</label>
                    <select id="edit-student-course" class="form-control">
                        <option value="medicine">Medicina</option>
                        <option value="nursing">Enfermagem</option>
                        <option value="dentistry">Odontologia</option>
                        <option value="physiotherapy">Fisioterapia</option>
                        <option value="nutrition">Nutrição</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-student-username">Nome de Usuário</label>
                    <input type="text" id="edit-student-username" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="edit-student-password">Senha</label>
                    <input type="password" id="edit-student-password" class="form-control" placeholder="Deixe em branco para manter a atual">
                </div>
                
                <div class="form-group">
                    <label>Senha Atual</label>
                    <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="current-password-display"></div>
                </div>
                
                <div class="form-group">
                    <label>Data de Criação</label>
                    <div id="edit-student-created" class="form-control" style="background-color: transparent; border: none; padding: 0; opacity: 0.7;" readonly></div>
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="showScreen('student-view-screen')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="saveStudentChanges()">
                        <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tela de Visualização de Professor (Admin) -->
        <div id="teacher-view-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('teacher-screen')"></i> Perfil do Professor</h1>
            </div>
            
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="profile-info">
                        <div class="profile-name" id="teacher-view-name">Nome do Professor</div>
                        <div class="profile-course" id="teacher-view-role">Professor</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Informações do Professor</div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label>Data de Nascimento</label>
                            <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="teacher-view-birthdate"></div>
                        </div>
                        <div class="form-group">
                            <label>CPF</label>
                            <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="teacher-view-cpf"></div>
                        </div>
                        <div class="form-group">
                            <label>Matrícula</label>
                            <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="teacher-view-registration"></div>
                        </div>
                        <!-- Motivo de bloqueio -->
                        <div id="teacher-view-block-reason" class="form-group" style="display: none;">
                            <label>Motivo do Bloqueio</label>
                            <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="teacher-block-reason"></div>
                        </div>
                    </div>
                </div>
                
                <div id="admin-actions-container">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Ações Administrativas</div>
                        </div>
                        <div class="card-content">
                            <div class="admin-actions">
                                <button class="admin-btn admin-btn-primary" onclick="editTeacher()">
                                    <i class="fas fa-edit"></i> Editar Professor
                                </button>
                                <button id="block-teacher-btn" class="admin-btn admin-btn-warning" onclick="showBlockModalTeacher()">
                                    <i class="fas fa-ban"></i> Bloquear Professor
                                </button>
                                <button class="admin-btn admin-btn-danger" onclick="deleteTeacher()">
                                    <i class="fas fa-trash"></i> Excluir Professor
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tela de Edição de Professor (Admin) -->
        <div id="edit-teacher-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('teacher-view-screen')"></i> Editar Professor</h1>
            </div>
            
            <div class="form-container">
                <div class="form-group">
                    <label for="edit-teacher-fullname">Nome Completo</label>
                    <input type="text" id="edit-teacher-fullname" class="form-control">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-teacher-birthdate">Data de Nascimento</label>
                        <input type="date" id="edit-teacher-birthdate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="edit-teacher-cpf">CPF</label>
                        <input type="text" id="edit-teacher-cpf" class="form-control" maxlength="14">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-teacher-registration">Número de Matrícula</label>
                    <input type="text" id="edit-teacher-registration" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="edit-teacher-username">Nome de Usuário</label>
                    <input type="text" id="edit-teacher-username" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="edit-teacher-password">Senha</label>
                    <input type="password" id="edit-teacher-password" class="form-control" placeholder="Deixe em branco para manter a atual">
                </div>
                
                <div class="form-group">
                    <label>Senha Atual</label>
                    <div class="form-control" style="background-color: transparent; border: none; padding: 0;" id="current-teacher-password-display"></div>
                </div>
                
                <div class="form-group">
                    <label>Data de Criação</label>
                    <div id="edit-teacher-created" class="form-control" style="background-color: transparent; border: none; padding: 0; opacity: 0.7;" readonly></div>
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="showScreen('teacher-view-screen')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="saveTeacherChanges()">
                        <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tela de Avaliação Detalhada -->
        <div id="evaluation-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('teacher-screen')"></i> Avaliação</h1>
            </div>
            
            <div class="evaluation-container">
                <div class="evaluation-header">
                    <div class="evaluation-title" id="evaluation-title">Título do Diário</div>
                    <div class="evaluation-date" id="evaluation-date">Data: 00/00/0000</div>
                    <div style="margin-top: 5px;">
                        <div>Aluno: <span id="evaluation-student-name"></span></div>
                        <div>Matrícula: <span id="evaluation-student-registration"></span></div>
                    </div>
                    <div class="evaluation-status" id="evaluation-status" style="margin-top: 5px; display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 0.8rem; background-color: rgba(255,255,255,0.1);">
                        <i class="fas fa-clock"></i> Pendente
                    </div>
                </div>
                
                <div class="evaluation-content">
                    <div class="evaluation-text" id="evaluation-text">
                        Conteúdo do diário de campo será exibido aqui.
                    </div>
                </div>
                
                <!-- Container para imagens do diário -->
                <div class="thumbnail-container" id="evaluation-images-container">
                    <!-- Imagens serão adicionadas dinamicamente -->
                </div>
                
                <div class="form-group">
                    <label for="evaluation-grade">Nota (0-10)</label>
                    <input type="number" id="evaluation-grade" class="form-control" min="0" max="10" step="0.1" placeholder="Digite a nota">
                </div>
                
                <div class="form-group">
                    <label for="evaluation-comment">Comentários</label>
                    <textarea id="evaluation-comment" class="form-control" rows="4" placeholder="Digite seus comentários sobre o diário"></textarea>
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="showScreen('teacher-screen')">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary" onclick="saveEvaluation()">
                        <i class="fas fa-check"></i> Salvar Avaliação
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tela de Notificações -->
        <div id="notifications-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="goBackFromNotifications()"></i> Notificações</h1>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Minhas Notificações</div>
                </div>
                <div class="card-content" id="notifications-list">
                    <p>Carregando notificações...</p>
                </div>
            </div>
        </div>
        
        <!-- Tela VirtualClass -->
        <div id="virtualclass-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('hub-screen')"></i> VirtualClass</h1>
                <button id="reload-virtualclass" style="background: none; border: none; color: white; font-size: 1.2rem;">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="virtualclass-loader" class="spinner"></div>
            <iframe id="virtualclass-iframe" class="webview-container" src="https://appfunorte.virtualclass.com.br/Index20.jsp"></iframe>
        </div>
        
        <!-- Tela de Gerenciamento de Mensagens (Admin) -->
        <div id="messages-screen" class="screen hidden">
            <div class="header">
                <h1><i class="fas fa-arrow-left" onclick="showScreen('teacher-screen')"></i> Mensagens Ativas</h1>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Mensagens Ativas</div>
                </div>
                <div class="card-content" id="active-messages-list">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para criação de usuários -->
    <div id="create-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Criar Novo Usuário</div>
                <div class="modal-close" onclick="hideCreateUserModal()">&times;</div>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="new-user-fullname">Nome Completo</label>
                    <input type="text" id="new-user-fullname" class="form-control" placeholder="Digite o nome completo">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-user-birthdate">Data de Nascimento</label>
                        <input type="date" id="new-user-birthdate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-user-cpf">CPF</label>
                        <input type="text" id="new-user-cpf" class="form-control" placeholder="000.000.000-00" maxlength="14">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="new-user-registration">Número de Matrícula</label>
                    <input type="text" id="new-user-registration" class="form-control" placeholder="Digite a matrícula">
                </div>
                
                <div class="form-group">
                    <label for="new-user-course">Curso</label>
                    <select id="new-user-course" class="form-control">
                        <option value="">Selecione o curso</option>
                        <option value="medicine">Medicina</option>
                        <option value="nursing">Enfermagem</option>
                        <option value="dentistry">Odontologia</option>
                        <option value="physiotherapy">Fisioterapia</option>
                        <option value="nutrition">Nutrição</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="new-user-username">Nome de Usuário</label>
                    <input type="text" id="new-user-username" class="form-control" placeholder="Crie um nome de usuário">
                </div>
                
                <div class="form-group">
                    <label for="new-user-password">Senha</label>
                    <input type="password" id="new-user-password" class="form-control" placeholder="Crie uma senha">
                </div>
                
                <div class="form-group">
                    <label for="new-user-role">Tipo de Usuário</label>
                    <select id="new-user-role" class="form-control">
                        <option value="student">Aluno</option>
                        <option value="teacher">Professor</option>
                    </select>
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="hideCreateUserModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="createNewUser()">
                        <i class="fas fa-check"></i> Criar Usuário
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualização de diário -->
    <div id="diary-modal" class="diary-modal">
        <div class="diary-modal-content">
            <div class="diary-modal-header">
                <div class="diary-modal-title" id="diary-modal-title">Título do Diário</div>
                <div class="diary-modal-close" onclick="hideDiaryModal()">&times;</div>
            </div>
            <div class="diary-info">
                <div>Data: <span id="diary-modal-date"></span></div>
                <div>Enviado por: <span id="diary-modal-author"></span></div>
            </div>
            <div class="diary-content" id="diary-modal-content">
                Conteúdo do diário será exibido aqui...
            </div>
            
            <!-- Container para imagens do diário -->
            <div id="diary-images-container" class="images-container" style="margin-top: 15px;"></div>
            
            <div class="diary-grade" id="diary-modal-grade" style="display: none;">
                <strong>Nota:</strong> <span id="diary-grade-value"></span>
            </div>
            <div class="diary-comments" id="diary-modal-comments" style="display: none;">
                <strong>Comentários:</strong> <span id="diary-comments-value"></span>
            </div>
        </div>
    </div>

    <!-- Modal para envio de mensagens -->
    <div id="send-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Enviar Mensagem</div>
                <div class="modal-close" onclick="hideSendMessageModal()">&times;</div>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="message-recipients">Destinatários</label>
                    <select id="message-recipients" class="form-control">
                        <option value="all">Todos os usuários</option>
                        <option value="students">Todos os alunos</option>
                        <option value="teachers">Todos os professores</option>
                        <option value="course">Por curso</option>
                    </select>
                </div>
                
                <div id="course-select-container" class="form-group" style="display: none;">
                    <label for="message-course">Curso</label>
                    <select id="message-course" class="form-control">
                        <option value="medicine">Medicina</option>
                        <option value="nursing">Enfermagem</option>
                        <option value="dentistry">Odontologia</option>
                        <option value="physiotherapy">Fisioterapia</option>
                        <option value="nutrition">Nutrição</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="message-title">Título</label>
                    <input type="text" id="message-title" class="form-control" placeholder="Título da mensagem">
                </div>
                
                <div class="form-group">
                    <label for="message-content">Mensagem</label>
                    <textarea id="message-content" class="form-control" rows="4" placeholder="Digite sua mensagem"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="message-duration">Duração (dias)</label>
                    <input type="number" id="message-duration" class="form-control" min="1" value="1">
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="hideSendMessageModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i> Enviar Mensagem
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para motivo de bloqueio -->
    <div id="block-modal" class="block-modal">
        <div class="block-modal-content">
            <div class="block-modal-title">Motivo do Bloqueio</div>
            <textarea id="block-reason-input" class="block-modal-textarea" placeholder="Informe o motivo do bloqueio..."></textarea>
            <div class="block-modal-buttons">
                <button class="btn btn-secondary" onclick="hideBlockModal()">Cancelar</button>
                <button id="confirm-block-btn" class="btn btn-primary" onclick="confirmBlock()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para seleção de ícone de perfil -->
    <div id="icon-selector-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Selecionar Ícone de Perfil</div>
                <div class="modal-close" onclick="hideIconSelector()">&times;</div>
            </div>
            <div class="icon-grid" id="icon-grid">
                <!-- Ícones serão adicionados dinamicamente -->
            </div>
            <div class="btn-container" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveProfileIcon()">
                    <i class="fas fa-save"></i> Salvar Ícone
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para carrossel de imagens -->
    <div id="image-carousel-modal" class="carousel-modal">
        <div class="carousel-container">
            <div class="carousel-close" onclick="hideImageCarousel()">&times;</div>
            <!-- As imagens serão inseridas aqui dinamicamente -->
            <div class="carousel-nav carousel-prev" onclick="prevImage()">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="carousel-nav carousel-next" onclick="nextImage()">
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="carousel-counter" id="carousel-counter"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBq15tSYzmQPBQBSjrj3RMBL1y-kB6TTck",
            authDomain: "funortehub.firebaseapp.com",
            projectId: "funortehub",
            storageBucket: "funortehub.appspot.com",
            messagingSenderId: "369651480275",
            appId: "1:369651480275:web:37601f22df012d94800626"
        };

        // Inicializa o Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();

        // Estado global da aplicação
        const appState = {
            currentUser: null,
            userData: null,
            submissions: [],
            students: [],
            teachers: [],
            currentStudent: null,
            currentTeacher: null,
            currentDiary: null,
            notifications: [],
            studentsPage: 1,
            teachersPage: 1,
            submissionsPage: 1,
            pageSize: 5,
            touchStartX: 0,
            currentNotificationId: null,
            blockTargetId: null,
            blockTargetType: null,
            studentsListener: null,
            teachersListener: null,
            submissionsListener: null,
            messagesListener: null,
            selectedIcon: null,
            // Estado para imagens
            diaryImages: [],
            carouselImages: [],
            currentCarouselIndex: 0,
            // Credenciais do Imgur
            imgurClientId: '4ae8b96c539d446',
            imgurAccessToken: '898e039bb7db651c7b94f4d104a60aae3f5c6ff0'
        };

        // Navegação entre telas
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.remove('hidden');
            document.getElementById(screenId).classList.add('active');
            
            // Carrega dados específicos da tela quando ela é aberta
            if (screenId === 'hub-screen' && appState.currentUser) {
                updateUserGreeting();
                checkNotifications();
                loadPersistentMessages();
                loadProfessors();
                setupMessagesListener();
            } else if (screenId === 'submissions-screen') {
                loadUserSubmissions();
            } else if (screenId === 'teacher-screen') {
                checkNotifications();
                if (appState.userData.role === 'admin') {
                    document.getElementById('create-user-btn').style.display = 'block';
                    document.getElementById('send-message-btn').style.display = 'block';
                    document.getElementById('manage-messages-btn').style.display = 'block';
                    document.getElementById('teachers-card').style.display = 'block';
                    loadTeachers();
                }
                loadStudents();
                setupMessagesListener();
            } else if (screenId === 'profile-screen') {
                loadProfileData();
            } else if (screenId === 'notifications-screen') {
                loadNotifications();
            } else if (screenId === 'diary-screen') {
                loadProfessors();
                setCurrentDate();
                // Resetar imagens ao entrar na tela
                appState.diaryImages = [];
                renderImageUploads();
                // Configurar input de imagens
                setupImageInput();
            } else if (screenId === 'virtualclass-screen') {
                document.getElementById('virtualclass-iframe').src = "https://appfunorte.virtualclass.com.br/Index20.jsp";
            } else if (screenId === 'messages-screen') {
                loadActiveMessages();
            } else {
                if (appState.messagesListener) {
                    appState.messagesListener();
                    appState.messagesListener = null;
                }
            }
        }

        // Configurar input de imagens
        function setupImageInput() {
            const imageInput = document.getElementById('image-input');
            imageInput.onchange = function(e) {
                handleImageSelection(e);
            };
        }

        // Manipular seleção de imagens
        function handleImageSelection(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            // Limitar a 5 imagens
            const remainingSlots = 5 - appState.diaryImages.length;
            if (remainingSlots <= 0) {
                alert('Você já selecionou o máximo de 5 imagens!');
                return;
            }
            
            const filesToAdd = Math.min(files.length, remainingSlots);
            
            for (let i = 0; i < filesToAdd; i++) {
                const file = files[i];
                
                // Verificar se é imagem
                if (!file.type.match('image.*')) {
                    alert('Por favor, selecione apenas arquivos de imagem!');
                    continue;
                }
                
                // Adicionar ao estado
                appState.diaryImages.push({
                    id: Date.now() + i,
                    file: file,
                    status: 'pending',
                    url: null,
                    error: null
                });
            }
            
            // Renderizar as imagens
            renderImageUploads();
            
            // Iniciar upload das imagens
            uploadImages();
            
            // Resetar o input para permitir novas seleções
            event.target.value = '';
        }

        // Renderizar imagens para upload
        function renderImageUploads() {
            const container = document.getElementById('image-upload-container');
            container.innerHTML = '';
            
            // Adicionar botão de upload
            const uploadBtn = document.createElement('div');
            uploadBtn.className = 'image-upload-btn';
            uploadBtn.innerHTML = '<i class="fas fa-plus"></i>';
            uploadBtn.onclick = function() {
                document.getElementById('image-input').click();
            };
            container.appendChild(uploadBtn);
            
            // Adicionar as imagens
            appState.diaryImages.forEach(image => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.dataset.id = image.id;
                
                // Pré-visualização
                if (image.file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-preview';
                        img.onclick = function() {
                            if (image.url) {
                                showImageCarousel([image.url]);
                            }
                        };
                        imageItem.appendChild(img);
                    };
                    reader.readAsDataURL(image.file);
                }
                
                // Botão de remover
                const removeBtn = document.createElement('div');
                removeBtn.className = 'image-remove';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = function() {
                    removeImage(image.id);
                };
                imageItem.appendChild(removeBtn);
                
                // Estado de upload
                if (image.status === 'uploading') {
                    const uploading = document.createElement('div');
                    uploading.className = 'image-uploading';
                    uploading.innerHTML = '<div class="spinner"></div>';
                    imageItem.appendChild(uploading);
                }
                else if (image.status === 'error') {
                    const error = document.createElement('div');
                    error.className = 'image-uploading';
                    error.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    imageItem.appendChild(error);
                }
                
                container.insertBefore(imageItem, uploadBtn);
            });
        }

        // Remover imagem
        function removeImage(imageId) {
            appState.diaryImages = appState.diaryImages.filter(img => img.id !== imageId);
            renderImageUploads();
        }

        // Fazer upload das imagens para o Imgur
        async function uploadImages() {
            const imagesToUpload = appState.diaryImages.filter(img => 
                img.status === 'pending' && img.file
            );
            
            if (imagesToUpload.length === 0) return;
            
            for (const image of imagesToUpload) {
                try {
                    // Atualizar status para uploading
                    image.status = 'uploading';
                    renderImageUploads();
                    
                    const formData = new FormData();
                    formData.append('image', image.file);
                    
                    const response = await fetch('https://api.imgur.com/3/image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.imgurAccessToken}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        image.url = data.data.link;
                        image.status = 'done';
                    } else {
                        image.status = 'error';
                        image.error = data.data.error || 'Erro no upload';
                    }
                } catch (error) {
                    image.status = 'error';
                    image.error = error.message;
                }
                
                renderImageUploads();
            }
        }

        // Função para abrir o VirtualClass
        function openVirtualClass() {
            showScreen('virtualclass-screen');
        }

        // Definir data atual
        function setCurrentDate() {
            // Obter data atual no formato YYYY-MM-DD (horário de Brasília)
            const now = new Date();
            const offset = -3 * 60; // UTC-3 em minutos
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const brasiliaTime = new Date(utc + (3600000 * offset / 60));
            
            const year = brasiliaTime.getFullYear();
            const month = String(brasiliaTime.getMonth() + 1).padStart(2, '0');
            const day = String(brasiliaTime.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            document.getElementById('diary-date').value = dateStr;
        }

        // Mostrar modal de criação de usuário
        function showCreateUserModal() {
            document.getElementById('create-user-modal').style.display = 'flex';
        }

        // Esconder modal de criação de usuário
        function hideCreateUserModal() {
            document.getElementById('create-user-modal').style.display = 'none';
        }

        // Mostrar modal de visualização de diário
        function showDiaryModal(title, date, content, author, grade, comments, images) {
            document.getElementById('diary-modal-title').textContent = title;
            document.getElementById('diary-modal-date').textContent = formatDate(date);
            document.getElementById('diary-modal-author').textContent = author;
            document.getElementById('diary-modal-content').textContent = content;
            
            const gradeContainer = document.getElementById('diary-modal-grade');
            const commentsContainer = document.getElementById('diary-modal-comments');
            const imagesContainer = document.getElementById('diary-images-container');
            
            // Limpar imagens anteriores
            imagesContainer.innerHTML = '';
            
            // Adicionar imagens se existirem
            if (images && images.length > 0) {
                images.forEach((img, index) => {
                    const imgElement = document.createElement('img');
                    imgElement.src = img;
                    imgElement.className = 'image-preview';
                    imgElement.style.width = '80px';
                    imgElement.style.height = '80px';
                    imgElement.style.cursor = 'pointer';
                    imgElement.onclick = function() {
                        showImageCarousel(images, index);
                    };
                    imagesContainer.appendChild(imgElement);
                });
            }
            
            if (grade) {
                document.getElementById('diary-grade-value').textContent = grade;
                gradeContainer.style.display = 'block';
            } else {
                gradeContainer.style.display = 'none';
            }
            
            if (comments) {
                document.getElementById('diary-comments-value').textContent = comments;
                commentsContainer.style.display = 'block';
            } else {
                commentsContainer.style.display = 'none';
            }
            
            document.getElementById('diary-modal').style.display = 'flex';
        }

        // Esconder modal de visualização de diário
        function hideDiaryModal() {
            document.getElementById('diary-modal').style.display = 'none';
        }

        // Mostrar modal de envio de mensagens
        function showSendMessageModal() {
            document.getElementById('send-message-modal').style.display = 'flex';
        }

        // Esconder modal de envio de mensagens
        function hideSendMessageModal() {
            document.getElementById('send-message-modal').style.display = 'none';
        }

        // Mostrar modal de motivo de bloqueio
        function showBlockModal() {
            document.getElementById('block-reason-input').value = '';
            document.getElementById('block-modal').style.display = 'flex';
            appState.blockTargetType = 'student';
        }

        // Mostrar modal de motivo de bloqueio para professores
        function showBlockModalTeacher() {
            document.getElementById('block-reason-input').value = '';
            document.getElementById('block-modal').style.display = 'flex';
            appState.blockTargetType = 'teacher';
        }

        // Esconder modal de motivo de bloqueio
        function hideBlockModal() {
            document.getElementById('block-modal').style.display = 'none';
        }

        // Mostrar tela de gerenciamento de mensagens
        function showMessagesScreen() {
            showScreen('messages-screen');
        }

        // Atualiza a saudação do usuário
        function updateUserGreeting() {
            if (appState.userData) {
                const firstName = appState.userData.fullname.split(' ')[0];
                document.getElementById('user-greeting').textContent = firstName;
            }
        }

        // Formatação de data corrigida
        function formatDate(dateInput) {
            if (!dateInput) return 'Não informado';
            
            try {
                let date;
                if (dateInput.toDate) {
                    date = dateInput.toDate();
                } else {
                    date = new Date(dateInput);
                }

                // Ajustar para o fuso horário de Brasília (UTC-3)
                const offset = -3;
                const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
                const brasiliaTime = new Date(utc + (3600000 * offset));

                return brasiliaTime.toLocaleDateString('pt-BR');
            } catch (e) {
                console.error('Erro ao formatar data:', e);
                return 'Data inválida';
            }
        }

        // Carregar dados do perfil
        function loadProfileData() {
            if (!appState.userData) return;
            
            document.getElementById('profile-name').textContent = appState.userData.fullname;
            document.getElementById('profile-course').textContent = getCourseName(appState.userData.course);
            
            document.getElementById('edit-fullname').value = appState.userData.fullname || '';
            document.getElementById('edit-birthdate').value = appState.userData.birthdate || '';
            document.getElementById('edit-cpf').value = appState.userData.cpf || '';
            document.getElementById('edit-registration').value = appState.userData.registration || '';
            document.getElementById('edit-course').value = appState.userData.course || '';
            document.getElementById('edit-username').value = appState.userData.username || '';
            
            // Carregar ícone do perfil
            const profileIcon = document.getElementById('profile-icon');
            if (appState.userData.profileIcon) {
                profileIcon.className = appState.userData.profileIcon;
            }
        }

        // Atualizar perfil
        async function updateProfile() {
            if (!appState.currentUser) return;
            
            const fullname = document.getElementById('edit-fullname').value;
            const birthdate = document.getElementById('edit-birthdate').value;
            const cpf = document.getElementById('edit-cpf').value;
            const registration = document.getElementById('edit-registration').value;
            const username = document.getElementById('edit-username').value;
            const password = document.getElementById('edit-password').value;
            
            if (!fullname || !birthdate || !cpf || !registration || !username) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            try {
                const updateData = {
                    fullname,
                    birthdate,
                    cpf,
                    registration,
                    username,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (password) {
                    updateData.password = password;
                }
                
                // Atualiza no Firestore
                await db.collection('alunos').doc(appState.currentUser.id).update(updateData);
                
                // Atualiza o estado da aplicação
                appState.userData = {
                    ...appState.userData,
                    ...updateData
                };
                
                alert('Perfil atualizado com sucesso!');
                showScreen('hub-screen');
                
            } catch (error) {
                console.error('Erro ao atualizar perfil:', error);
                alert('Erro ao atualizar perfil: ' + error.message);
            }
        }

        // Mostrar perfil
        function showProfile() {
            showScreen('profile-screen');
        }

        // Obter nome do curso
        function getCourseName(courseId) {
            const courses = {
                'medicine': 'Medicina',
                'nursing': 'Enfermagem',
                'dentistry': 'Odontologia',
                'physiotherapy': 'Fisioterapia',
                'nutrition': 'Nutrição'
            };
            return courses[courseId] || 'Curso não especificado';
        }

        // Carregar professores para o campo de seleção
        async function loadProfessors() {
            try {
                const professorSelect = document.getElementById('professor');
                professorSelect.innerHTML = '<option value="">Selecione o professor</option>';
                
                const snapshot = await db.collection('professores').get();
                
                snapshot.forEach(doc => {
                    const professor = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `Dr(a). ${professor.fullname}`;
                    professorSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Erro ao carregar professores:', error);
            }
        }

        // Registro de usuário
        async function registerUser() {
            const fullname = document.getElementById('fullname').value;
            const birthdate = document.getElementById('birthdate').value;
            const cpf = document.getElementById('cpf').value;
            const registration = document.getElementById('registration').value;
            const course = document.getElementById('course').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Validação simples
            if (!fullname || !birthdate || !cpf || !registration || !course || !username || !password) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            try {
                // Verificar se o usuário já existe
                const userQuery = await db.collection('users').where('username', '==', username).get();
                
                if (!userQuery.empty) {
                    alert('Nome de usuário já em uso!');
                    return;
                }

                // Criar usuário no Firestore
                const userData = {
                    fullname,
                    birthdate,
                    cpf,
                    registration,
                    course,
                    username,
                    password,
                    role: 'student',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active',
                    profileIcon: 'fas fa-user'
                };

                // Salva na coleção de alunos
                const userRef = await db.collection('alunos').add(userData);
                
                // Também salva na coleção geral de usuários
                await db.collection('users').add({
                    ...userData,
                    userId: userRef.id
                });
                
                // Atualizar estado da aplicação
                appState.currentUser = {
                    id: userRef.id,
                    username
                };
                
                appState.userData = userData;
                
                // Mostrar tela principal
                showScreen('hub-screen');
                
            } catch (error) {
                console.error('Erro no registro:', error);
                alert('Erro ao registrar: ' + error.message);
            }
        }

        // Criar novo usuário (pelo admin)
        async function createNewUser() {
            const fullname = document.getElementById('new-user-fullname').value;
            const birthdate = document.getElementById('new-user-birthdate').value;
            const cpf = document.getElementById('new-user-cpf').value;
            const registration = document.getElementById('new-user-registration').value;
            const course = document.getElementById('new-user-course').value;
            const username = document.getElementById('new-user-username').value;
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;
            
            // Validação simples
            if (!fullname || !birthdate || !cpf || !registration || !course || !username || !password) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            try {
                // Verificar se o usuário já existe
                const userQuery = await db.collection('users').where('username', '==', username).get();
                
                if (!userQuery.empty) {
                    alert('Nome de usuário já em uso!');
                    return;
                }

                // Criar usuário no Firestore
                const userData = {
                    fullname,
                    birthdate,
                    cpf,
                    registration,
                    course,
                    username,
                    password,
                    role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active',
                    profileIcon: role === 'student' ? 'fas fa-user' : 'fas fa-chalkboard-teacher'
                };

                // Salva na coleção apropriada
                let userRef;
                if (role === 'student') {
                    userRef = await db.collection('alunos').add(userData);
                } else {
                    userRef = await db.collection('professores').add(userData);
                }

                // Também salva na coleção geral de usuários
                await db.collection('users').add({
                    ...userData,
                    userId: userRef.id
                });
                
                alert('Usuário criado com sucesso!');
                hideCreateUserModal();
                
                // Recarrega lista apropriada
                if (role === 'student') {
                    loadStudents();
                } else {
                    loadTeachers();
                }
                
            } catch (error) {
                console.error('Erro ao criar usuário:', error);
                alert('Erro ao criar usuário: ' + error.message);
            }
        }

        // Login do usuário
        async function loginUser() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            // Validação simples
            if (!username || !password) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            // Login de administrador (exceção)
            if (username === 'admin' && password === 'admin123') {
                appState.currentUser = { 
                    id: 'admin',
                    username: 'admin'
                };
                appState.userData = {
                    fullname: 'Administrador',
                    role: 'admin',
                    course: 'all'
                };
                showScreen('teacher-screen');
                document.getElementById('create-user-btn').style.display = 'block';
                document.getElementById('send-message-btn').style.display = 'block';
                document.getElementById('manage-messages-btn').style.display = 'block';
                document.getElementById('teachers-card').style.display = 'block';
                loadTeachers();
                return;
            }

            try {
                // Buscar usuário nas coleções 'alunos' e 'professores'
                const [alunosQuery, professoresQuery] = await Promise.all([
                    db.collection('alunos')
                        .where('username', '==', username)
                        .where('password', '==', password)
                        .limit(1)
                        .get(),
                    db.collection('professores')
                        .where('username', '==', username)
                        .where('password', '==', password)
                        .limit(1)
                        .get()
                ]);
                
                let userDoc;
                if (!alunosQuery.empty) {
                    userDoc = alunosQuery.docs[0];
                } else if (!professoresQuery.empty) {
                    userDoc = professoresQuery.docs[0];
                } else {
                    throw new Error('Usuário ou senha incorretos');
                }
                
                // Verificar se o usuário está bloqueado
                if (userDoc.data().status === 'blocked') {
                    document.getElementById('blocked-message').style.display = 'block';
                    document.getElementById('block-reason').textContent = userDoc.data().blockReason || 'Conta suspensa por violação dos termos de uso';
                    return;
                } else {
                    document.getElementById('blocked-message').style.display = 'none';
                }
                
                appState.currentUser = {
                    id: userDoc.id,
                    username
                };
                
                appState.userData = userDoc.data();
                
                // Mostrar tela apropriada baseada no tipo de usuário
                if (appState.userData.role === 'teacher' || appState.userData.role === 'admin') {
                    showScreen('teacher-screen');
                    if (appState.userData.role === 'admin') {
                        document.getElementById('create-user-btn').style.display = 'block';
                        document.getElementById('send-message-btn').style.display = 'block';
                        document.getElementById('manage-messages-btn').style.display = 'block';
                        document.getElementById('teachers-card').style.display = 'block';
                        loadTeachers();
                    }
                } else {
                    showScreen('hub-screen');
                }
                
            } catch (error) {
                console.error('Erro no login:', error);
                alert('Erro ao fazer login: ' + error.message);
            }
        }

        // Logout
        function logout() {
            // Parar todos os listeners
            if (appState.studentsListener) {
                appState.studentsListener();
            }
            if (appState.teachersListener) {
                appState.teachersListener();
            }
            if (appState.submissionsListener) {
                appState.submissionsListener();
            }
            if (appState.messagesListener) {
                appState.messagesListener();
            }
            
            appState.currentUser = null;
            appState.userData = null;
            appState.currentStudent = null;
            appState.currentDiary = null;
            showScreen('home-screen');
        }

        // Limpar campos do diário
        function clearDiaryFields() {
            document.getElementById('diary-title').value = '';
            document.getElementById('diary-text').value = '';
            document.getElementById('professor').selectedIndex = 0;
            appState.diaryImages = [];
            renderImageUploads();
        }

        // Voltar da tela de diário
        function backFromDiaryScreen() {
            clearDiaryFields();
            showScreen('hub-screen');
        }

        // Enviar diário de campo
        async function submitDiary() {
            if (!appState.currentUser) {
                alert('Você precisa estar logado para enviar um diário!');
                return;
            }
            
            const date = document.getElementById('diary-date').value;
            const title = document.getElementById('diary-title').value;
            const text = document.getElementById('diary-text').value;
            const professor = document.getElementById('professor').value;
            
            if (!date || !title || !text || !professor) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Verificar se há uploads pendentes
            const pendingUploads = appState.diaryImages.filter(img => 
                img.status === 'uploading' || img.status === 'pending'
            );
            
            if (pendingUploads.length > 0) {
                alert('Aguarde o término do upload das imagens antes de enviar!');
                return;
            }
            
            // Obter URLs das imagens enviadas com sucesso
            const imageUrls = appState.diaryImages
                .filter(img => img.status === 'done' && img.url)
                .map(img => img.url);
            
            try {
                // Criar documento no Firestore
                const diaryRef = await db.collection('Diario').add({
                    userId: appState.currentUser.id,
                    userName: appState.userData.fullname,
                    userRegistration: appState.userData.registration, // Adiciona a matrícula
                    userCourse: appState.userData.course,
                    date: date,
                    title: title,
                    text: text,
                    images: imageUrls, // Armazenar URLs das imagens
                    professor: professor,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Criar notificação para o professor
                await db.collection('notifications').add({
                    userId: professor,
                    type: 'new_diary',
                    diaryId: diaryRef.id,
                    studentId: appState.currentUser.id,
                    studentName: appState.userData.fullname,
                    title: 'Novo diário de campo',
                    message: `${appState.userData.fullname} enviou um novo diário de campo para avaliação.`,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Diário enviado com sucesso!');
                clearDiaryFields();
                showScreen('hub-screen');
                
            } catch (error) {
                console.error('Erro ao enviar diário:', error);
                alert('Erro ao enviar diário: ' + error.message);
            }
        }

        // Carregar envios do usuário (ALUNO)
        async function loadUserSubmissions() {
            if (!appState.currentUser) return;
            
            const submissionsList = document.getElementById('my-submissions-list');
            submissionsList.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Configurar listener em tempo real
                if (appState.submissionsListener) {
                    appState.submissionsListener();
                }
                
                appState.submissionsListener = db.collection('Diario')
                    .where('userId', '==', appState.currentUser.id)
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        if (snapshot.empty) {
                            submissionsList.innerHTML = '<p>Nenhum diário enviado ainda.</p>';
                            return;
                        }
                        
                        appState.submissions = snapshot.docs.map(doc => ({ 
                            id: doc.id, 
                            ...doc.data() 
                        }));
                        
                        // Atualizar UI
                        submissionsList.innerHTML = '';
                        
                        appState.submissions.forEach(submission => {
                            const submissionItem = document.createElement('div');
                            submissionItem.className = 'submission-item';
                            submissionItem.style.padding = '15px';
                            submissionItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                            submissionItem.style.cursor = 'pointer';
                            submissionItem.onclick = () => showDiaryModal(
                                submission.title, 
                                submission.date, 
                                submission.text, 
                                submission.userName,
                                submission.grade,
                                submission.comments,
                                submission.images // Passar imagens para o modal
                            );
                            
                            let statusBadge = '';
                            if (submission.status === 'pending') {
                                statusBadge = `<div style="background-color: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                                    <i class="fas fa-clock"></i> Pendente
                                </div>`;
                            } else if (submission.status === 'reviewed') {
                                statusBadge = `<div style="background-color: var(--success); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                                    <i class="fas fa-check-circle"></i> Visualizado
                                </div>`;
                            }
                            
                            let gradeBadge = '';
                            if (submission.grade) {
                                gradeBadge = `<div style="background-color: var(--warning); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                                    Nota: ${submission.grade}
                                </div>`;
                            }
                            
                            // Badge de imagens
                            let imagesBadge = '';
                            if (submission.images && submission.images.length > 0) {
                                imagesBadge = `<div style="background-color: #3498db; padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                                    <i class="fas fa-camera"></i> ${submission.images.length}
                                </div>`;
                            }
                            
                            submissionItem.innerHTML = `
                                <div style="display: flex; justify-content: space-between;">
                                    <div style="font-weight: 500;">${submission.title}</div>
                                    <div style="font-size: 0.8rem; color: var(--light-gray);">${formatDate(submission.date)}</div>
                                </div>
                                <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                                    ${submission.text.substring(0, 50)}${submission.text.length > 50 ? '...' : ''}
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 10px;">
                                    ${statusBadge}
                                    ${gradeBadge}
                                    ${imagesBadge}
                                </div>
                            `;
                            
                            submissionsList.appendChild(submissionItem);
                        });
                    }, error => {
                        console.error('Erro ao carregar envios:', error);
                        submissionsList.innerHTML = `<p>Erro ao carregar seus diários: ${error.message}</p>`;
                    });
                
            } catch (error) {
                console.error('Erro ao carregar envios:', error);
                submissionsList.innerHTML = `<p>Erro ao carregar seus diários: ${error.message}</p>`;
            }
        }

        // Carregar alunos por curso (PROFESSOR) com listener em tempo real
        function loadStudents() {
            const course = document.getElementById('teacher-course-select').value;
            if (!course) return;
            
            const studentsList = document.getElementById('students-list');
            studentsList.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Remover listener anterior se existir
                if (appState.studentsListener) {
                    appState.studentsListener();
                }
                
                // Configurar query baseada nos filtros
                let query = db.collection('alunos').where('course', '==', course);
                
                // Configurar listener em tempo real
                appState.studentsListener = query.onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        studentsList.innerHTML = '<p>Nenhum aluno encontrado para este curso.</p>';
                        document.getElementById('students-pagination').style.display = 'none';
                        return;
                    }
                    
                    appState.students = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // Atualiza a lista de alunos
                    updateStudentsList();
                }, error => {
                    console.error('Erro ao carregar alunos:', error);
                    studentsList.innerHTML = `<p>Erro ao carregar alunos: ${error.message}</p>`;
                });
                
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                studentsList.innerHTML = `<p>Erro ao carregar alunos: ${error.message}</p>`;
            }
        }

        // Filtrar alunos por nome
        function filterStudents() {
            const searchTerm = document.getElementById('search-student-alunos').value.toLowerCase();
            const filteredStudents = appState.students.filter(student => 
                student.fullname.toLowerCase().includes(searchTerm)
            );
            
            const studentsList = document.getElementById('students-list');
            studentsList.innerHTML = '';
            
            if (filteredStudents.length === 0) {
                studentsList.innerHTML = '<p>Nenhum aluno encontrado para este critério de busca.</p>';
                return;
            }
            
            filteredStudents.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'submission-item';
                studentItem.style.padding = '15px';
                studentItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                studentItem.style.cursor = 'pointer';
                studentItem.onclick = () => viewStudent(student);
                
                // Ícone de bloqueado
                let blockedIcon = '';
                if (student.status === 'blocked') {
                    blockedIcon = '<i class="fas fa-ban blocked-icon"></i>';
                }
                
                studentItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div style="font-weight: 500;">${student.fullname} ${blockedIcon}</div>
                        <div style="font-size: 0.8rem; color: var(--light-gray);">${getCourseName(student.course)}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                        Matrícula: ${student.registration}
                    </div>
                `;
                
                studentsList.appendChild(studentItem);
            });
        }

        // Atualizar lista de alunos com paginação
        function updateStudentsList() {
            const studentsList = document.getElementById('students-list');
            const pagination = document.getElementById('students-pagination');
            const prevBtn = document.getElementById('prev-student-btn');
            const nextBtn = document.getElementById('next-student-btn');
            const pageInfo = document.getElementById('students-page-info');
            
            const startIndex = (appState.studentsPage - 1) * appState.pageSize;
            const endIndex = startIndex + appState.pageSize;
            const paginatedStudents = appState.students.slice(startIndex, endIndex);
            const totalPages = Math.ceil(appState.students.length / appState.pageSize);
            
            studentsList.innerHTML = '';
            
            if (paginatedStudents.length === 0) {
                studentsList.innerHTML = '<p>Nenhum aluno encontrado.</p>';
                pagination.style.display = 'none';
                return;
            }
            
            paginatedStudents.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'submission-item';
                studentItem.style.padding = '15px';
                studentItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                studentItem.style.cursor = 'pointer';
                studentItem.onclick = () => viewStudent(student);
                
                // Ícone de bloqueado
                let blockedIcon = '';
                if (student.status === 'blocked') {
                    blockedIcon = '<i class="fas fa-ban blocked-icon"></i>';
                }
                
                studentItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div style="font-weight: 500;">${student.fullname} ${blockedIcon}</div>
                        <div style="font-size: 0.8rem; color: var(--light-gray);">${getCourseName(student.course)}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                        Matrícula: ${student.registration}
                    </div>
                `;
                
                studentsList.appendChild(studentItem);
            });
            
            // Atualizar paginação
            pageInfo.textContent = `Página ${appState.studentsPage} de ${totalPages}`;
            prevBtn.disabled = appState.studentsPage === 1;
            nextBtn.disabled = appState.studentsPage === totalPages;
            pagination.style.display = 'flex';
        }

        // Página anterior de alunos
        function prevStudentsPage() {
            if (appState.studentsPage > 1) {
                appState.studentsPage--;
                updateStudentsList();
            }
        }

        // Próxima página de alunos
        function nextStudentsPage() {
            const totalPages = Math.ceil(appState.students.length / appState.pageSize);
            if (appState.studentsPage < totalPages) {
                appState.studentsPage++;
                updateStudentsList();
            }
        }

        // Visualizar aluno (PROFESSOR)
        function viewStudent(student) {
            appState.currentStudent = student;
            
            // Atualizar informações na tela
            document.getElementById('student-view-name').textContent = student.fullname;
            document.getElementById('student-view-course').textContent = getCourseName(student.course);
            document.getElementById('student-view-birthdate').textContent = formatDate(student.birthdate);
            document.getElementById('student-view-cpf').textContent = student.cpf;
            document.getElementById('student-view-registration').textContent = student.registration;
            
            // Mostrar motivo de bloqueio se existir
            if (student.status === 'blocked' && student.blockReason) {
                document.getElementById('student-view-block-reason').style.display = 'block';
                document.getElementById('student-block-reason').textContent = student.blockReason;
            } else {
                document.getElementById('student-view-block-reason').style.display = 'none';
            }
            
            // Mostrar ações administrativas apenas para admin
            if (appState.userData.role === 'admin') {
                document.getElementById('admin-actions-container').style.display = 'block';
                // Atualizar botão de bloqueio
                const blockBtn = document.getElementById('block-student-btn');
                if (student.status === 'blocked') {
                    blockBtn.innerHTML = '<i class="fas fa-unlock"></i> Desbloquear';
                    blockBtn.className = 'admin-btn admin-btn-success';
                } else {
                    blockBtn.innerHTML = '<i class="fas fa-ban"></i> Bloquear';
                    blockBtn.className = 'admin-btn admin-btn-warning';
                }
            } else {
                document.getElementById('admin-actions-container').style.display = 'none';
            }
            
            // Carregar diários do aluno
            loadStudentDiaries(student.id);
            
            // Mostrar tela
            showScreen('student-view-screen');
        }

        // Carregar diários do aluno (PROFESSOR)
        async function loadStudentDiaries(studentId) {
            const diariesList = document.getElementById('student-diaries-list');
            diariesList.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Configurar listener em tempo real
                if (appState.submissionsListener) {
                    appState.submissionsListener();
                }
                
                appState.submissionsListener = db.collection('Diario')
                    .where('userId', '==', studentId)
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        if (snapshot.empty) {
                            diariesList.innerHTML = '<p>Nenhum diário enviado por este aluno.</p>';
                            return;
                        }
                        
                        const diaries = snapshot.docs.map(doc => ({ 
                            id: doc.id, 
                            ...doc.data() 
                        }));
                        
                        // Atualizar UI
                        diariesList.innerHTML = '';
                        
                        diaries.forEach(diary => {
                            const diaryItem = document.createElement('div');
                            diaryItem.className = 'submission-item';
                            diaryItem.style.padding = '15px';
                            diaryItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                            diaryItem.style.cursor = 'pointer';
                            diaryItem.onclick = () => viewDiaryForEvaluation(diary);
                            
                            let statusBadge = '';
                            if (diary.status === 'pending') {
                                statusBadge = `<div style="background-color: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                                    <i class="fas fa-clock"></i> Pendente
                                </div>`;
                            } else if (diary.status === 'reviewed') {
                                statusBadge = `<div style="background-color: var(--success); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                                    <i class="fas fa-check-circle"></i> Visualizado
                                </div>`;
                            }
                            
                            // Badge de imagens
                            let imagesBadge = '';
                            if (diary.images && diary.images.length > 0) {
                                imagesBadge = `<div style="background-color: #3498db; padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                                    <i class="fas fa-camera"></i> ${diary.images.length}
                                </div>`;
                            }
                            
                            diaryItem.innerHTML = `
                                <div style="display: flex; justify-content: space-between;">
                                    <div style="font-weight: 500;">${diary.title}</div>
                                    <div style="font-size: 0.8rem; color: var(--light-gray);">${formatDate(diary.date)}</div>
                                </div>
                                <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                                    ${diary.text.substring(0, 50)}${diary.text.length > 50 ? '...' : ''}
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 10px;">
                                    ${statusBadge}
                                    ${imagesBadge}
                                </div>
                            `;
                            
                            diariesList.appendChild(diaryItem);
                        });
                    }, error => {
                        console.error('Erro ao carregar diários do aluno:', error);
                        diariesList.innerHTML = `<p>Erro ao carregar diários do aluno: ${error.message}</p>`;
                    });
                
            } catch (error) {
                console.error('Erro ao carregar diários do aluno:', error);
                diariesList.innerHTML = `<p>Erro ao carregar diários do aluno: ${error.message}</p>`;
            }
        }

        // Carregar professores (ADMIN) com listener em tempo real
        function loadTeachers() {
            const teachersList = document.getElementById('teachers-list');
            teachersList.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Remover listener anterior se existir
                if (appState.teachersListener) {
                    appState.teachersListener();
                }
                
                // Configurar listener em tempo real
                appState.teachersListener = db.collection('professores').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        teachersList.innerHTML = '<p>Nenhum professor encontrado.</p>';
                        document.getElementById('teachers-pagination').style.display = 'none';
                        return;
                    }
                    
                    appState.teachers = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // Atualiza a lista de professores
                    updateTeachersList();
                }, error => {
                    console.error('Erro ao carregar professores:', error);
                    teachersList.innerHTML = `<p>Erro ao carregar professores: ${error.message}</p>`;
                });
                
            } catch (error) {
                console.error('Erro ao carregar professores:', error);
                teachersList.innerHTML = `<p>Erro ao carregar professores: ${error.message}</p>`;
            }
        }

        // Filtrar professores por nome
        function filterTeachers() {
            const searchTerm = document.getElementById('search-professor').value.toLowerCase();
            const filteredTeachers = appState.teachers.filter(teacher => 
                teacher.fullname.toLowerCase().includes(searchTerm)
            );
            
            const teachersList = document.getElementById('teachers-list');
            teachersList.innerHTML = '';
            
            if (filteredTeachers.length === 0) {
                teachersList.innerHTML = '<p>Nenhum professor encontrado para este critério de busca.</p>';
                return;
            }
            
            filteredTeachers.forEach(teacher => {
                const teacherItem = document.createElement('div');
                teacherItem.className = 'submission-item';
                teacherItem.style.padding = '15px';
                teacherItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                teacherItem.style.cursor = 'pointer';
                teacherItem.onclick = () => viewTeacher(teacher);
                
                // Ícone de bloqueado
                let blockedIcon = '';
                if (teacher.status === 'blocked') {
                    blockedIcon = '<i class="fas fa-ban blocked-icon"></i>';
                }
                
                teacherItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div style="font-weight: 500;">Dr(a). ${teacher.fullname} ${blockedIcon}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                        Usuário: ${teacher.username}
                    </div>
                `;
                
                teachersList.appendChild(teacherItem);
            });
        }

        // Atualizar lista de professores com paginação
        function updateTeachersList() {
            const teachersList = document.getElementById('teachers-list');
            const pagination = document.getElementById('teachers-pagination');
            const prevBtn = document.getElementById('prev-teacher-btn');
            const nextBtn = document.getElementById('next-teacher-btn');
            const pageInfo = document.getElementById('teachers-page-info');
            
            const startIndex = (appState.teachersPage - 1) * appState.pageSize;
            const endIndex = startIndex + appState.pageSize;
            const paginatedTeachers = appState.teachers.slice(startIndex, endIndex);
            const totalPages = Math.ceil(appState.teachers.length / appState.pageSize);
            
            teachersList.innerHTML = '';
            
            if (paginatedTeachers.length === 0) {
                teachersList.innerHTML = '<p>Nenhum professor encontrado.</p>';
                pagination.style.display = 'none';
                return;
            }
            
            paginatedTeachers.forEach(teacher => {
                const teacherItem = document.createElement('div');
                teacherItem.className = 'submission-item';
                teacherItem.style.padding = '15px';
                teacherItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                teacherItem.style.cursor = 'pointer';
                teacherItem.onclick = () => viewTeacher(teacher);
                
                // Ícone de bloqueado
                let blockedIcon = '';
                if (teacher.status === 'blocked') {
                    blockedIcon = '<i class="fas fa-ban blocked-icon"></i>';
                }
                
                teacherItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div style="font-weight: 500;">Dr(a). ${teacher.fullname} ${blockedIcon}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                        Usuário: ${teacher.username}
                    </div>
                `;
                
                teachersList.appendChild(teacherItem);
            });
            
            // Atualizar paginação
            pageInfo.textContent = `Página ${appState.teachersPage} de ${totalPages}`;
            prevBtn.disabled = appState.teachersPage === 1;
            nextBtn.disabled = appState.teachersPage === totalPages;
            pagination.style.display = 'flex';
        }

        // Página anterior de professores
        function prevTeachersPage() {
            if (appState.teachersPage > 1) {
                appState.teachersPage--;
                updateTeachersList();
            }
        }

        // Próxima página de professores
        function nextTeachersPage() {
            const totalPages = Math.ceil(appState.teachers.length / appState.pageSize);
            if (appState.teachersPage < totalPages) {
                appState.teachersPage++;
                updateTeachersList();
            }
        }

        // Visualizar professor (ADMIN)
        function viewTeacher(teacher) {
            appState.currentTeacher = teacher;
            
            // Atualizar informações na tela
            document.getElementById('teacher-view-name').textContent = teacher.fullname;
            document.getElementById('teacher-view-birthdate').textContent = formatDate(teacher.birthdate);
            document.getElementById('teacher-view-cpf').textContent = teacher.cpf;
            document.getElementById('teacher-view-registration').textContent = teacher.registration;
            
            // Mostrar motivo de bloqueio se existir
            if (teacher.status === 'blocked' && teacher.blockReason) {
                document.getElementById('teacher-view-block-reason').style.display = 'block';
                document.getElementById('teacher-block-reason').textContent = teacher.blockReason;
            } else {
                document.getElementById('teacher-view-block-reason').style.display = 'none';
            }
            
            // Atualizar botão de bloqueio
            const blockBtn = document.getElementById('block-teacher-btn');
            if (teacher.status === 'blocked') {
                blockBtn.innerHTML = '<i class="fas fa-unlock"></i> Desbloquear';
                blockBtn.className = 'admin-btn admin-btn-success';
            } else {
                blockBtn.innerHTML = '<i class="fas fa-ban"></i> Bloquear';
                blockBtn.className = 'admin-btn admin-btn-warning';
            }
            
            // Mostrar tela
            showScreen('teacher-view-screen');
        }

        // Carregar submissões por curso (PROFESSOR) com listener em tempo real
        function loadSubmissions() {
            const course = document.getElementById('evaluation-course-select').value;
            if (!course) return;
            
            const filterMyStudents = document.getElementById('filter-my-students').checked;
            
            const submissionsList = document.getElementById('submissions-list');
            submissionsList.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Remover listener anterior se existir
                if (appState.submissionsListener) {
                    appState.submissionsListener();
                }
                
                // Configurar query baseada nos filtros
                let query = db.collection('Diario')
                    .where('userCourse', '==', course)
                    .orderBy('createdAt', 'desc');
                
                // Se o filtro "Apenas meus alunos" estiver ativo
                if (filterMyStudents && appState.userData.role === 'teacher') {
                    query = query.where('professor', '==', appState.currentUser.id);
                }
                
                // Configurar listener em tempo real
                appState.submissionsListener = query.onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        submissionsList.innerHTML = '<p>Nenhuma submissão encontrada.</p>';
                        document.getElementById('submissions-pagination').style.display = 'none';
                        return;
                    }
                    
                    appState.submissions = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    })).sort((a, b) => {
                        // Ordenar: pendentes primeiro, depois visualizados
                        if (a.status === 'pending' && b.status !== 'pending') return -1;
                        if (a.status !== 'pending' && b.status === 'pending') return 1;
                        return 0;
                    });
                    
                    // Atualiza a lista de submissões
                    updateSubmissionsList();
                }, error => {
                    console.error('Erro ao carregar submissões:', error);
                    submissionsList.innerHTML = `<p>Erro ao carregar submissões: ${error.message}</p>`;
                });
                
            } catch (error) {
                console.error('Erro ao carregar submissões:', error);
                submissionsList.innerHTML = `<p>Erro ao carregar submissões: ${error.message}</p>`;
            }
        }

        // Atualizar lista de submissões com paginação
        function updateSubmissionsList() {
            const submissionsList = document.getElementById('submissions-list');
            const pagination = document.getElementById('submissions-pagination');
            const prevBtn = document.getElementById('prev-submission-btn');
            const nextBtn = document.getElementById('next-submission-btn');
            const pageInfo = document.getElementById('submissions-page-info');
            
            const startIndex = (appState.submissionsPage - 1) * appState.pageSize;
            const endIndex = startIndex + appState.pageSize;
            const paginatedSubmissions = appState.submissions.slice(startIndex, endIndex);
            const totalPages = Math.ceil(appState.submissions.length / appState.pageSize);
            
            submissionsList.innerHTML = '';
            
            if (paginatedSubmissions.length === 0) {
                submissionsList.innerHTML = '<p>Nenhuma submissão encontrada.</p>';
                pagination.style.display = 'none';
                return;
            }
            
            paginatedSubmissions.forEach(submission => {
                const submissionItem = document.createElement('div');
                submissionItem.className = 'submission-item';
                submissionItem.style.padding = '15px';
                submissionItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                submissionItem.style.cursor = 'pointer';
                submissionItem.onclick = () => viewDiaryForEvaluation(submission);
                
                let statusBadge = '';
                if (submission.status === 'pending') {
                    statusBadge = `<div style="background-color: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                        <i class="fas fa-clock"></i> Pendente
                    </div>`;
                } else if (submission.status === 'reviewed') {
                    statusBadge = `<div style="background-color: var(--success); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                        <i class="fas fa-check-circle"></i> Visualizado
                    </div>`;
                }
                
                // Badge de imagens
                let imagesBadge = '';
                if (submission.images && submission.images.length > 0) {
                    imagesBadge = `<div style="background-color: #3498db; padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                        <i class="fas fa-camera"></i> ${submission.images.length}
                    </div>`;
                }
                
                submissionItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div style="font-weight: 500;">${submission.userName} - ${submission.title}</div>
                        <div style="font-size: 0.8rem; color: var(--light-gray);">${formatDate(submission.date)}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                        ${submission.text.substring(0, 50)}${submission.text.length > 50 ? '...' : ''}
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        ${statusBadge}
                        ${imagesBadge}
                    </div>
                `;
                
                submissionsList.appendChild(submissionItem);
            });
            
            // Atualizar paginação
            pageInfo.textContent = `Página ${appState.submissionsPage} de ${totalPages}`;
            prevBtn.disabled = appState.submissionsPage === 1;
            nextBtn.disabled = appState.submissionsPage === totalPages;
            pagination.style.display = 'flex';
        }

        // Página anterior de submissões
        function prevSubmissionsPage() {
            if (appState.submissionsPage > 1) {
                appState.submissionsPage--;
                updateSubmissionsList();
            }
        }

        // Próxima página de submissões
        function nextSubmissionsPage() {
            const totalPages = Math.ceil(appState.submissions.length / appState.pageSize);
            if (appState.submissionsPage < totalPages) {
                appState.submissionsPage++;
                updateSubmissionsList();
            }
        }

        // Filtrar submissões por nome do aluno
        function filterSubmissions() {
            const searchTerm = document.getElementById('search-student').value.toLowerCase();
            const filteredSubmissions = appState.submissions.filter(submission => 
                submission.userName.toLowerCase().includes(searchTerm)
            );
            
            const submissionsList = document.getElementById('submissions-list');
            submissionsList.innerHTML = '';
            
            if (filteredSubmissions.length === 0) {
                submissionsList.innerHTML = '<p>Nenhuma submissão encontrada para este critério de busca.</p>';
                return;
            }
            
            filteredSubmissions.forEach(submission => {
                const submissionItem = document.createElement('div');
                submissionItem.className = 'submission-item';
                submissionItem.style.padding = '15px';
                submissionItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                submissionItem.style.cursor = 'pointer';
                submissionItem.onclick = () => viewDiaryForEvaluation(submission);
                
                let statusBadge = '';
                if (submission.status === 'pending') {
                    statusBadge = `<div style="background-color: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                        <i class="fas fa-clock"></i> Pendente
                    </div>`;
                } else if (submission.status === 'reviewed') {
                    statusBadge = `<div style="background-color: var(--success); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                        <i class="fas fa-check-circle"></i> Visualizado
                    </div>`;
                }
                
                // Badge de imagens
                let imagesBadge = '';
                if (submission.images && submission.images.length > 0) {
                    imagesBadge = `<div style="background-color: #3498db; padding: 3px 8px; border-radius: 5px; font-size: 0.8rem;">
                        <i class="fas fa-camera"></i> ${submission.images.length}
                    </div>`;
                }
                
                submissionItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div style="font-weight: 500;">${submission.userName} - ${submission.title}</div>
                        <div style="font-size: 0.8rem; color: var(--light-gray);">${formatDate(submission.date)}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                        ${submission.text.substring(0, 50)}${submission.text.length > 50 ? '...' : ''}
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        ${statusBadge}
                        ${imagesBadge}
                    </div>
                `;
                
                submissionsList.appendChild(submissionItem);
            });
        }

        // Visualizar diário para avaliação
        function viewDiaryForEvaluation(diary) {
            appState.currentDiary = diary;
            
            // Atualizar informações na tela
            document.getElementById('evaluation-title').textContent = diary.title;
            document.getElementById('evaluation-date').textContent = `Data: ${formatDate(diary.date)}`;
            document.getElementById('evaluation-student-name').textContent = diary.userName;
            document.getElementById('evaluation-student-registration').textContent = diary.userRegistration;
            document.getElementById('evaluation-text').textContent = diary.text;
            
            // Atualizar status
            const statusElement = document.getElementById('evaluation-status');
            if (diary.status === 'pending') {
                statusElement.innerHTML = '<i class="fas fa-clock"></i> Pendente';
                statusElement.style.backgroundColor = 'rgba(255,255,255,0.1)';
            } else {
                statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Avaliado';
                statusElement.style.backgroundColor = 'var(--success)';
            }
            
            // Preencher nota e comentários se existirem
            document.getElementById('evaluation-grade').value = diary.grade || '';
            document.getElementById('evaluation-comment').value = diary.comments || '';
            
            // Preencher as imagens se existirem
            const imagesContainer = document.getElementById('evaluation-images-container');
            imagesContainer.innerHTML = '';
            
            if (diary.images && diary.images.length > 0) {
                diary.images.forEach((img, index) => {
                    const imgElement = document.createElement('img');
                    imgElement.src = img;
                    imgElement.className = 'thumbnail';
                    imgElement.style.cursor = 'pointer';
                    imgElement.onclick = function() {
                        showImageCarousel(diary.images, index);
                    };
                    imagesContainer.appendChild(imgElement);
                });
            } else {
                imagesContainer.innerHTML = '<p>Nenhuma imagem anexada.</p>';
            }
            
            // Mostrar tela de avaliação
            showScreen('evaluation-screen');
        }

        // Salvar avaliação
        async function saveEvaluation() {
            if (!appState.currentDiary || !appState.currentUser) return;
            
            const grade = document.getElementById('evaluation-grade').value;
            const comments = document.getElementById('evaluation-comment').value;
            
            try {
                // Atualizar diário no Firestore
                await db.collection('Diario').doc(appState.currentDiary.id).update({
                    status: 'reviewed',
                    grade: grade ? parseFloat(grade) : null,
                    comments: comments || '',
                    reviewedBy: appState.userData.fullname,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Criar notificação para o aluno
                await db.collection('notifications').add({
                    userId: appState.currentDiary.userId,
                    type: 'diary_reviewed',
                    diaryId: appState.currentDiary.id,
                    teacherId: appState.currentUser.id,
                    teacherName: appState.userData.fullname,
                    title: 'Diário avaliado',
                    message: `Seu diário "${appState.currentDiary.title}" foi avaliado pelo professor.`,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Avaliação salva com sucesso!');
                showScreen('teacher-screen');
                
            } catch (error) {
                console.error('Erro ao salvar avaliação:', error);
                alert('Erro ao salvar avaliação: ' + error.message);
            }
        }

        // Verificar notificações
        async function checkNotifications() {
            if (!appState.currentUser) return;
            
            try {
                const snapshot = await db.collection('notifications')
                    .where('userId', '==', appState.currentUser.id)
                    .where('read', '==', false)
                    .get();
                
                const count = snapshot.size;
                
                // Atualizar badge de notificação
                if (appState.userData.role === 'teacher' || appState.userData.role === 'admin') {
                    const badge = document.getElementById('notification-count');
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    const badge = document.getElementById('student-notification-count');
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Erro ao verificar notificações:', error);
            }
        }

        // Carregar notificações
        async function loadNotifications() {
            if (!appState.currentUser) return;
            
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '<div class="spinner"></div>';
            
            try {
                const snapshot = await db.collection('notifications')
                    .where('userId', '==', appState.currentUser.id)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const notifications = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                
                // Marcar todas as notificações como lidas
                const batch = db.batch();
                notifications.forEach(notification => {
                    if (!notification.read) {
                        const notificationRef = db.collection('notifications').doc(notification.id);
                        batch.update(notificationRef, {
                            read: true,
                            readAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
                await batch.commit();
                
                // Atualizar contador de notificações
                checkNotifications();
                
                // Atualizar UI
                notificationsList.innerHTML = '';
                
                if (notifications.length === 0) {
                    notificationsList.innerHTML = '<p>Nenhuma notificação encontrada.</p>';
                    return;
                }
                
                notifications.forEach(notification => {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = 'notification-item submission-item';
                    notificationItem.style.padding = '15px';
                    notificationItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                    notificationItem.style.position = 'relative';
                    
                    // Adicionar área de swipe para deletar
                    const swipeArea = document.createElement('div');
                    swipeArea.className = 'notification-swipe';
                    swipeArea.innerHTML = '<i class="fas fa-trash"></i>';
                    notificationItem.appendChild(swipeArea);
                    
                    // Adicionar evento de toque para swipe
                    notificationItem.addEventListener('touchstart', e => {
                        appState.touchStartX = e.touches[0].clientX;
                        notificationItem.classList.add('swiping');
                    });
                    
                    notificationItem.addEventListener('touchmove', e => {
                        const touchX = e.touches[0].clientX;
                        const diff = appState.touchStartX - touchX;
                        
                        if (diff > 50) {
                            notificationItem.classList.add('deleting');
                        } else {
                            notificationItem.classList.remove('deleting');
                        }
                    });
                    
                    notificationItem.addEventListener('touchend', async () => {
                        if (notificationItem.classList.contains('deleting')) {
                            // Excluir notificação
                            try {
                                await db.collection('notifications').doc(notification.id).delete();
                                notificationItem.remove();
                                checkNotifications();
                            } catch (error) {
                                console.error('Erro ao excluir notificação:', error);
                                alert('Erro ao excluir notificação: ' + error.message);
                            }
                        } else {
                            notificationItem.classList.remove('swiping', 'deleting');
                        }
                    });
                    
                    // Conteúdo da notificação
                    const content = document.createElement('div');
                    content.innerHTML = `
                        <div style="display: flex; justify-content: space-between;">
                            <div style="font-weight: 500;">${notification.title}</div>
                            <div style="font-size: 0.8rem; color: var(--light-gray);">${formatDate(notification.createdAt)}</div>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;">
                            ${notification.message}
                        </div>
                        ${!notification.read ? `<div style="margin-top: 10px;">
                            <div style="background-color: var(--accent); padding: 3px 8px; border-radius: 5px; font-size: 0.8rem; display: inline-block;">
                                Nova
                            </div>
                        </div>` : ''}
                    `;
                    
                    notificationItem.appendChild(content);
                    notificationsList.appendChild(notificationItem);
                });
                
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
                notificationsList.innerHTML = `<p>Erro ao carregar notificações: ${error.message}</p>`;
            }
        }

        // Mostrar notificações
        function showNotifications() {
            showScreen('notifications-screen');
        }

        // Voltar da tela de notificações
        function goBackFromNotifications() {
            if (appState.userData.role === 'teacher' || appState.userData.role === 'admin') {
                showScreen('teacher-screen');
            } else {
                showScreen('hub-screen');
            }
        }

        // Editar aluno (admin)
        function editStudent() {
            if (!appState.currentStudent) return;
            
            // Preencher formulário com dados do aluno
            document.getElementById('edit-student-fullname').value = appState.currentStudent.fullname || '';
            document.getElementById('edit-student-birthdate').value = appState.currentStudent.birthdate || '';
            document.getElementById('edit-student-cpf').value = appState.currentStudent.cpf || '';
            document.getElementById('edit-student-registration').value = appState.currentStudent.registration || '';
            document.getElementById('edit-student-course').value = appState.currentStudent.course || '';
            document.getElementById('edit-student-username').value = appState.currentStudent.username || '';
            document.getElementById('edit-student-created').textContent = formatDate(appState.currentStudent.createdAt) || 'Não disponível';
            document.getElementById('current-password-display').textContent = appState.currentStudent.password || 'Não disponível';
            
            showScreen('edit-student-screen');
        }

        // Editar professor (admin)
        function editTeacher() {
            if (!appState.currentTeacher) return;
            
            // Preencher formulário com dados do professor
            document.getElementById('edit-teacher-fullname').value = appState.currentTeacher.fullname || '';
            document.getElementById('edit-teacher-birthdate').value = appState.currentTeacher.birthdate || '';
            document.getElementById('edit-teacher-cpf').value = appState.currentTeacher.cpf || '';
            document.getElementById('edit-teacher-registration').value = appState.currentTeacher.registration || '';
            document.getElementById('edit-teacher-username').value = appState.currentTeacher.username || '';
            document.getElementById('edit-teacher-created').textContent = formatDate(appState.currentTeacher.createdAt) || 'Não disponível';
            document.getElementById('current-teacher-password-display').textContent = appState.currentTeacher.password || 'Não disponível';
            
            showScreen('edit-teacher-screen');
        }

        // Confirmar bloqueio/desbloqueio
        async function confirmBlock() {
            const reason = document.getElementById('block-reason-input').value;
            let collectionName, target;
            
            if (appState.blockTargetType === 'student') {
                collectionName = 'alunos';
                target = appState.currentStudent;
            } else if (appState.blockTargetType === 'teacher') {
                collectionName = 'professores';
                target = appState.currentTeacher;
            } else {
                return;
            }
            
            if (!reason && target.status !== 'blocked') {
                alert('É necessário informar um motivo para bloquear!');
                return;
            }
            
            try {
                const newStatus = target.status === 'blocked' ? 'active' : 'blocked';
                const updateData = {
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (newStatus === 'blocked') {
                    updateData.blockReason = reason;
                } else {
                    updateData.blockReason = '';
                }
                
                await db.collection(collectionName).doc(target.id).update(updateData);
                
                // Atualizar estado
                target.status = newStatus;
                target.blockReason = newStatus === 'blocked' ? reason : '';
                
                if (newStatus === 'blocked') {
                    alert(appState.blockTargetType === 'student' ? 'Aluno bloqueado com sucesso!' : 'Professor bloqueado com sucesso!');
                } else {
                    alert(appState.blockTargetType === 'student' ? 'Aluno desbloqueado com sucesso!' : 'Professor desbloqueado com sucesso!');
                }
                
                hideBlockModal();
                
                // Recarrega a visualização
                if (appState.blockTargetType === 'student') {
                    viewStudent(target);
                } else {
                    viewTeacher(target);
                }
                
            } catch (error) {
                console.error('Erro ao bloquear/desbloquear:', error);
                alert('Erro ao bloquear/desbloquear: ' + error.message);
            }
        }

        // Excluir aluno
        async function deleteStudent() {
            if (!appState.currentStudent) return;
            
            if (!confirm('Tem certeza que deseja excluir permanentemente este aluno?')) {
                return;
            }
            
            try {
                await db.collection('alunos').doc(appState.currentStudent.id).delete();
                // Excluir também da coleção geral de usuários
                const userQuery = await db.collection('users').where('userId', '==', appState.currentStudent.id).get();
                userQuery.forEach(async doc => {
                    await doc.ref.delete();
                });
                
                alert('Aluno excluído com sucesso!');
                showScreen('teacher-screen');
                
            } catch (error) {
                console.error('Erro ao excluir aluno:', error);
                alert('Erro ao excluir aluno: ' + error.message);
            }
        }

        // Excluir professor
        async function deleteTeacher() {
            if (!appState.currentTeacher) return;
            
            if (!confirm('Tem certeza que deseja excluir permanentemente este professor?')) {
                return;
            }
            
            try {
                await db.collection('professores').doc(appState.currentTeacher.id).delete();
                // Excluir também da coleção geral de usuários
                const userQuery = await db.collection('users').where('userId', '==', appState.currentTeacher.id).get();
                userQuery.forEach(async doc => {
                    await doc.ref.delete();
                });
                
                alert('Professor excluído com sucesso!');
                showScreen('teacher-screen');
                
            } catch (error) {
                console.error('Erro ao excluir professor:', error);
                alert('Erro ao excluir professor: ' + error.message);
            }
        }

        // Enviar mensagem (admin)
        async function sendMessage() {
            if (!appState.currentUser || appState.userData.role !== 'admin') return;
            
            const recipients = document.getElementById('message-recipients').value;
            const course = document.getElementById('message-course').value;
            const title = document.getElementById('message-title').value;
            const content = document.getElementById('message-content').value;
            const duration = parseInt(document.getElementById('message-duration').value) || 1;
            
            if (!title || !content) {
                alert('Por favor, preencha o título e o conteúdo da mensagem!');
                return;
            }
            
            try {
                const messageData = {
                    title,
                    content,
                    senderId: appState.currentUser.id,
                    senderName: appState.userData.fullname,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    recipientType: recipients
                };
                
                if (recipients === 'course') {
                    messageData.course = course;
                }
                
                // Calcular data de expiração
                const expirationDate = new Date();
                expirationDate.setDate(expirationDate.getDate() + duration);
                messageData.expiration = expirationDate;
                
                // Salvar mensagem na coleção
                await db.collection('messages').add(messageData);
                
                alert('Mensagem enviada com sucesso!');
                hideSendMessageModal();
                
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                alert('Erro ao enviar mensagem: ' + error.message);
            }
        }

        // Carregar mensagens ativas
        async function loadActiveMessages() {
            if (!appState.currentUser || appState.userData.role !== 'admin') return;
            
            const messagesList = document.getElementById('active-messages-list');
            messagesList.innerHTML = '<div class="spinner"></div>';
            
            try {
                const now = new Date();
                const snapshot = await db.collection('messages')
                    .where('expiration', '>', now)
                    .orderBy('expiration', 'asc')
                    .get();
                
                const messages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                messagesList.innerHTML = '';
                
                if (messages.length === 0) {
                    messagesList.innerHTML = '<p>Nenhuma mensagem ativa encontrada.</p>';
                    return;
                }
                
                messages.forEach(message => {
                    const messageItem = document.createElement('div');
                    messageItem.className = 'message-item';
                    
                    let recipientText = '';
                    switch (message.recipientType) {
                        case 'all':
                            recipientText = 'Todos os usuários';
                            break;
                        case 'students':
                            recipientText = 'Todos os alunos';
                            break;
                        case 'teachers':
                            recipientText = 'Todos os professores';
                            break;
                        case 'course':
                            recipientText = `Curso: ${getCourseName(message.course)}`;
                            break;
                    }
                    
                    messageItem.innerHTML = `
                        <div class="message-content">
                            <div><strong>${message.title}</strong></div>
                            <div>${message.content}</div>
                            <div class="message-expiration">
                                Expira em: ${formatDate(message.expiration)}
                            </div>
                            <div style="font-size: 0.8rem; opacity: 0.7;">
                                ${recipientText}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteMessage('${message.id}')" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    messagesList.appendChild(messageItem);
                });
                
            } catch (error) {
                console.error('Erro ao carregar mensagens ativas:', error);
                messagesList.innerHTML = `<p>Erro ao carregar mensagens ativas: ${error.message}</p>`;
            }
        }

        // Excluir mensagem
        async function deleteMessage(messageId) {
            if (!confirm('Tem certeza que deseja excluir esta mensagem?')) {
                return;
            }
            
            try {
                await db.collection('messages').doc(messageId).delete();
                loadActiveMessages();
                alert('Mensagem excluída com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir mensagem:', error);
                alert('Erro ao excluir mensagem: ' + error.message);
            }
        }

        // Configurar listener de mensagens
        function setupMessagesListener() {
            if (!appState.currentUser || !appState.userData) return;
            
            // Parar listener anterior se existir
            if (appState.messagesListener) {
                appState.messagesListener();
            }
            
            const messagesContainer = document.getElementById('persistent-messages-container');
            
            // Obter data/hora atual
            const now = new Date();
            
            appState.messagesListener = db.collection('messages')
                .where('expiration', '>', now)
                .onSnapshot(snapshot => {
                    messagesContainer.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        
                        // Verificar se a mensagem é destinada ao usuário atual
                        let shouldDisplay = false;
                        
                        if (message.recipientType === 'all') {
                            shouldDisplay = true;
                        } else if (message.recipientType === 'students' && appState.userData.role === 'student') {
                            shouldDisplay = true;
                        } else if (message.recipientType === 'teachers' && 
                                  (appState.userData.role === 'teacher' || appState.userData.role === 'admin')) {
                            shouldDisplay = true;
                        } else if (message.recipientType === 'course' && 
                                  appState.userData.course === message.course) {
                            shouldDisplay = true;
                        }
                        
                        if (shouldDisplay) {
                            const messageElement = document.createElement('div');
                            messageElement.className = 'persistent-message';
                            messageElement.innerHTML = `
                                <div><strong>${message.title}</strong></div>
                                <div>${message.content}</div>
                            `;
                            messagesContainer.appendChild(messageElement);
                        }
                    });
                });
        }

        // Carregar mensagens persistentes
        async function loadPersistentMessages() {
            if (!appState.currentUser) return;
            
            try {
                const now = new Date();
                const snapshot = await db.collection('messages')
                    .where('expiration', '>', now)
                    .get();
                
                const messagesContainer = document.getElementById('persistent-messages-container');
                messagesContainer.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    
                    // Verificar se a mensagem é destinada ao usuário atual
                    let shouldDisplay = false;
                    
                    if (message.recipientType === 'all') {
                        shouldDisplay = true;
                    } else if (message.recipientType === 'students' && appState.userData.role === 'student') {
                        shouldDisplay = true;
                    } else if (message.recipientType === 'teachers' && 
                              (appState.userData.role === 'teacher' || appState.userData.role === 'admin')) {
                        shouldDisplay = true;
                    } else if (message.recipientType === 'course' && 
                              appState.userData.course === message.course) {
                        shouldDisplay = true;
                    }
                    
                    if (shouldDisplay) {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'persistent-message';
                        messageElement.innerHTML = `
                            <div><strong>${message.title}</strong></div>
                            <div>${message.content}</div>
                        `;
                        messagesContainer.appendChild(messageElement);
                    }
                });
                
            } catch (error) {
                console.error('Erro ao carregar mensagens persistentes:', error);
            }
        }

        // Mostrar seletor de ícones
        function showIconSelector() {
            const iconGrid = document.getElementById('icon-grid');
            iconGrid.innerHTML = '';
            
            // Ícones atualizados: medicina, fantasma, herói, robô, alienígena
            const icons = [
                'fas fa-user', 'fas fa-user-graduate', 'fas fa-user-tie', 'fas fa-user-md',
                'fas fa-user-nurse', 'fas fa-user-injured', 'fas fa-user-astronaut', 'fas fa-user-secret',
                'fas fa-user-ninja', 'fas fa-heart', 'fas fa-code', 'fas fa-stethoscope',
                'fas fa-ghost', 'fas fa-mask', 'fas fa-robot', 'fas fa-brain',
                'fas fa-user-circle', 'fas fa-smile', 'fas fa-laugh', 'fas fa-grin',
                'fas fa-meh', 'fas fa-frown', 'fas fa-paw', 'fas fa-star'
            ];
            
            icons.forEach(iconClass => {
                const iconOption = document.createElement('div');
                iconOption.className = 'icon-option';
                if (appState.userData.profileIcon === iconClass) {
                    iconOption.classList.add('selected');
                }
                iconOption.innerHTML = `<i class="${iconClass}"></i>`;
                iconOption.onclick = () => {
                    document.querySelectorAll('.icon-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    iconOption.classList.add('selected');
                    appState.selectedIcon = iconClass;
                };
                iconGrid.appendChild(iconOption);
            });
            
            document.getElementById('icon-selector-modal').style.display = 'flex';
        }

        // Esconder seletor de ícones
        function hideIconSelector() {
            document.getElementById('icon-selector-modal').style.display = 'none';
        }

        // Salvar ícone de perfil
        async function saveProfileIcon() {
            if (!appState.currentUser || !appState.selectedIcon) return;
            
            try {
                await db.collection('alunos').doc(appState.currentUser.id).update({
                    profileIcon: appState.selectedIcon
                });
                
                // Atualizar estado da aplicação
                appState.userData.profileIcon = appState.selectedIcon;
                
                // Atualizar ícone na UI
                document.getElementById('profile-icon').className = appState.selectedIcon;
                
                hideIconSelector();
                alert('Ícone de perfil atualizado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar ícone de perfil:', error);
                alert('Erro ao salvar ícone de perfil: ' + error.message);
            }
        }

        // Mostrar carrossel de imagens
        function showImageCarousel(images, startIndex = 0) {
            appState.carouselImages = images;
            appState.currentCarouselIndex = startIndex;
            
            const container = document.querySelector('.carousel-container');
            container.innerHTML = `
                <div class="carousel-close" onclick="hideImageCarousel()">&times;</div>
                ${images.map((img, index) => `
                    <img src="${img}" class="carousel-image ${index === startIndex ? 'active' : ''}" 
                         onclick="event.stopPropagation()">
                `).join('')}
                <div class="carousel-nav carousel-prev" onclick="prevImage()">
                    <i class="fas fa-chevron-left"></i>
                </div>
                <div class="carousel-nav carousel-next" onclick="nextImage()">
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="carousel-counter" id="carousel-counter">
                    ${startIndex + 1} / ${images.length}
                </div>
            `;
            
            document.getElementById('image-carousel-modal').style.display = 'flex';
        }

        // Esconder carrossel de imagens
        function hideImageCarousel() {
            document.getElementById('image-carousel-modal').style.display = 'none';
            appState.carouselImages = [];
        }

        // Navegar para imagem anterior
        function prevImage() {
            if (appState.carouselImages.length === 0) return;
            
            appState.currentCarouselIndex = (appState.currentCarouselIndex - 1 + appState.carouselImages.length) % appState.carouselImages.length;
            updateCarousel();
        }

        // Navegar para próxima imagem
        function nextImage() {
            if (appState.carouselImages.length === 0) return;
            
            appState.currentCarouselIndex = (appState.currentCarouselIndex + 1) % appState.carouselImages.length;
            updateCarousel();
        }

        // Atualizar carrossel
        function updateCarousel() {
            const images = document.querySelectorAll('.carousel-image');
            images.forEach((img, index) => {
                if (index === appState.currentCarouselIndex) {
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
            
            document.getElementById('carousel-counter').textContent = 
                `${appState.currentCarouselIndex + 1} / ${appState.carouselImages.length}`;
        }

        // Máscara de CPF
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            
            if (value.length > 9) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2}).*/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{3})(\d{3})(\d{0,3}).*/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/^(\d{3})(\d{0,3}).*/, '$1.$2');
            }
            
            e.target.value = value;
        });

        // Máscara de CPF para o modal
        document.getElementById('new-user-cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            
            if (value.length > 9) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2}).*/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{3})(\d{3})(\d{0,3}).*/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/^(\d{3})(\d{0,3}).*/, '$1.$2');
            }
            
            e.target.value = value;
        });

        // Mostrar/ocultar opções de curso para mensagens
        document.getElementById('message-recipients').addEventListener('change', function() {
            const courseContainer = document.getElementById('course-select-container');
            courseContainer.style.display = this.value === 'course' ? 'block' : 'none';
        });

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar o Service Worker:', error);
                    });
            });
        }

        // Prevenir zoom
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        // Configurar recarregamento do VirtualClass
        document.getElementById('reload-virtualclass').addEventListener('click', function() {
            const iframe = document.getElementById('virtualclass-iframe');
            const loader = document.getElementById('virtualclass-loader');
            loader.style.display = 'block';
            iframe.src = iframe.src;
        });

        // Ocultar loader quando o iframe carregar
        document.getElementById('virtualclass-iframe').addEventListener('load', function() {
            document.getElementById('virtualclass-loader').style.display = 'none';
        });

        // Inicializar data ao carregar
        window.addEventListener('load', function() {
            setCurrentDate();
        });
    </script>
</body>
</html>
